---
title: "Fig4D.Rmd"
author: "Alcala"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Figure 4 panel D: multi-regional sampling analysis

This document produces panel D from Figure 4 from the lungNENomics manuscript, displaying the profile of samples with multi-regional sequencing available.

## Load libraries

```{r pressure, echo=FALSE}
library(tidyverse)
library(patchwork)
library(ggbeeswarm)
library(ggpubr)
library(cluster)
library(ParetoTI)
```

```{r}
library(reticulate)
reticulate::use_condaenv(condaenv="/home/alcalan/miniconda3/envs/reticulate_PCHA")
```

## load lungNENomics color schemes
For now, this only runs locally. Nevertheless, not necessary to run, just provides cosmetics.
```{r}
source("/data/lungNENomics/work/Descriptive_manuscript_data/Colour_palettes.R")
```

## Load useful files

```{r}
# Base MOFA
load("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined/ParetoTI/variables_archetypes_MOFA_LNET.RData") # data also contained in Table S1
rownames(var_LNET) = var_LNET$sample_id
var_cli = var_LNET

# Base Pareto
load("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined/ParetoTI/proportions_K4LFs3.RData") # 
head(proportions_k4LFs3)

# Technical data 
#load("/data/lungNENomics/work/Descriptive_manuscript_data/Technical_data/combined_public_lungNENomics_technical_data.RData")

# ITH sample info
load("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/ITH_sample_information.RData")
head(info_table)

# Mean euclidean distances within archetypes 
LFs_Pareto <- var_cli[,c(3,4,7)]

euclidean_matrix_A1 <- dist(LFs_Pareto[which(rownames(LFs_Pareto) %in% rownames(var_cli)[which(var_cli$archetype_k4_LF3_label=="Ca A1")]),])
plot(density(euclidean_matrix_A1))
mean(euclidean_matrix_A1) # 1.175585
median(euclidean_matrix_A1) # 1.084373

euclidean_matrix_A2 <- dist(LFs_Pareto[which(rownames(LFs_Pareto) %in% rownames(var_cli)[which(var_cli$archetype_k4_LF3_label=="Ca A2")]),])
plot(density(euclidean_matrix_A2))
mean(euclidean_matrix_A2) # 0.9431505
median(euclidean_matrix_A2) # 0.8667797

euclidean_matrix_B <- dist(LFs_Pareto[which(rownames(LFs_Pareto) %in% rownames(var_cli)[which(var_cli$archetype_k4_LF3_label=="Ca B")]),])
plot(density(euclidean_matrix_B))
mean(euclidean_matrix_B) # 1.313523
median(euclidean_matrix_B) # 1.148625

euclidean_matrix_sc <- dist(LFs_Pareto[which(rownames(LFs_Pareto) %in% rownames(var_cli)[which(var_cli$archetype_k4_LF3_label=="sc-enriched")]),])
plot(density(euclidean_matrix_sc))
mean(euclidean_matrix_sc) # 1.808392
median(euclidean_matrix_sc) # 1.786972

#rm(euclidean_matrix_A1, euclidean_matrix_A2, euclidean_matrix_B, euclidean_matrix_sc)
```

## Analysis

We now read the data and analyse it sample by sample

#### LNEN099 - A1
```{r}
euclidean_dists = tibble()
#technical_complete[which(technical_complete$manuscript_id=="LNEN099"),c(1,22,34)]
#       sample_id omics_group               cohort
# 336 LNEN099_TU2        Meth lungNENomicsCombined
# 337 LNEN099_TU3        Meth                 <NA>

LFs_LNEN099_TU3 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN099_TU3/LFs_319.Cordin.txt")
euclidean_LNEN099 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN099_TU2"),],LFs_LNEN099_TU3[which(rownames(LFs_LNEN099_TU3)=="LNEN099_TU3"),c(1,2,5)])
dist(euclidean_LNEN099) # 0.2776905

LFs_LNEN099_TU3$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN099_TU3), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = "LNEN099_TU3"
sample_id_tmp.original = "LNEN099_TU2"
LFs_tmp = LFs_LNEN099_TU3

arc_ks.LFs.noboot = k_fit_pch( t(LFs_tmp[,c(1,2,5)]), ks = 4, check_installed = F,bootstrap = F, volume_ratio = "t_ratio" )
tern_arc = as_tibble( t( arc_ks.LFs.noboot$S ) )

all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #all in same order

pareto_coord.tab = bind_rows(tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]),
  tibble(sample_id = sample_id_tmp,
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp][1])
)

# compute silhouette
LFs_tmp$archetype_k4_LF3_label[LFs_tmp$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmp$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) ,
                c(sample=sample_id_tmp,silhouette(as.numeric(as.factor(LFs_tmp$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmp[,c(1,2,5)]))[which(rownames(LFs_tmp)==sample_id_tmp),]) )


p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN099_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN099_TU2 (meth)") + theme(plot.title = element_text(hjust = 0.5))

p2 <- ggplot(LFs_LNEN099_TU3, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN099_TU3[rownames(LFs_LNEN099_TU3) == "LNEN099_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN099_TU3 (meth)") + theme(plot.title = element_text(hjust = 0.5))

euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_LNEN099)[-2],
                              sample2=rownames(euclidean_LNEN099)[-1], 
                              dist = dist(euclidean_LNEN099)) )

p1 + p2
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN099_TU3/LF_scatters_LF1LF2.pdf", h=5,w=13)
#patchwork
##dev.off() 

#rm(euclidean_LNEN099, LFs_LNEN099_TU3, p1, p2, patchwork)
```
  
#### LNEN103 - A1
```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN103"),c(1,22,34)]
#       sample_id omics_group               cohort
# 346 LNEN103_TU1   Expr.Meth                 <NA>
# 347 LNEN103_TU2   Expr.Meth lungNENomicsCombined

LFs_LNEN103_TU1 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN103_TU1/LFs_319.Cordin.txt")
euclidean_LNEN103 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN103_TU2"),],LFs_LNEN103_TU1[which(rownames(LFs_LNEN103_TU1)=="LNEN103_TU1"),c(1,2,5)])
dist(euclidean_LNEN103) # 1.530477

LFs_LNEN103_TU1$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN103_TU1), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_LNEN103)[-2],
                              sample2=rownames(euclidean_LNEN103)[-1], 
                              dist = dist(euclidean_LNEN103)) )

# ParetoTI arc analysis
sample_id_tmp = "LNEN103_TU1"
sample_id_tmp.original = "LNEN103_TU2"
LFs_tmp = LFs_LNEN103_TU1

arc_ks.LFs.noboot = k_fit_pch( t(LFs_tmp[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" )
tern_arc = as_tibble( t( arc_ks.LFs.noboot$S ) )

all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #all in same order

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]),
  tibble(sample_id = sample_id_tmp,
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp][1])
)

# compute silhouette
LFs_tmp$archetype_k4_LF3_label[LFs_tmp$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmp$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) ,
                c(sample=sample_id_tmp,silhouette(as.numeric(as.factor(LFs_tmp$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmp[,c(1,2,5)]))[which(rownames(LFs_tmp)==sample_id_tmp),]) )

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN103_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN103_TU2 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN103_TU1, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN103_TU1[rownames(LFs_LNEN103_TU1) == "LNEN103_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN103_TU1 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(var_cli, aes(x=Factor1, y=Factor5, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor5") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN103_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN103_TU2 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p4 <- ggplot(LFs_LNEN103_TU1, aes(x=Factor1, y=Factor5, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor5") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN103_TU1[rownames(LFs_LNEN103_TU1) == "LNEN103_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN103_TU1 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))


p1 + p2 + p3 + p4
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN103_TU1/LF_scatters.pdf", h=10,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN103, LFs_LNEN103_TU1, p1, p2, p3, p4, patchwork)
```

# LNEN106 - B
```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN106"),c(1,22,34)]
#        sample_id   omics_group               cohort
# 353 LNEN106_TU1 WGS.Expr.Meth lungNENomicsCombined
# 354 LNEN106_TU2          Expr                 <NA>

LFs_LNEN106_TU2 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN106_TU2/LFs_319.Cordin.txt")
# LF5 is flipped - flip back for calculations and plotting 
colnames(LFs_LNEN106_TU2)[5] <- "Factor5_o"
LFs_LNEN106_TU2$Factor5 <- LFs_LNEN106_TU2$Factor5_o*-1

euclidean_LNEN106 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN106_TU1"),],LFs_LNEN106_TU2[which(rownames(LFs_LNEN106_TU2)=="LNEN106_TU2"),c(1,2,11)])
dist(euclidean_LNEN106) # 0.2701073

euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_LNEN106)[-2],
                               sample2=rownames(euclidean_LNEN106)[-1], 
                               dist = dist(euclidean_LNEN106)) )

LFs_LNEN106_TU2$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN106_TU2), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = "LNEN106_TU2"
sample_id_tmp.original = "LNEN106_TU1"
LFs_tmp = LFs_LNEN106_TU2

arc_ks.LFs.noboot = k_fit_pch( t(LFs_tmp[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" )
tern_arc = as_tibble( t( arc_ks.LFs.noboot$S ) )

neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]),
  tibble(sample_id = sample_id_tmp,
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp][1])
)

# compute silhouette
LFs_tmp$archetype_k4_LF3_label[LFs_tmp$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmp$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) ,
                c(sample=sample_id_tmp,silhouette(as.numeric(as.factor(LFs_tmp$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmp[,c(1,2,5)]))[which(rownames(LFs_tmp)==sample_id_tmp),]) )

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN106_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN106_TU1 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN106_TU2, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN106_TU2[rownames(LFs_LNEN106_TU2) == "LNEN106_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN106_TU2 (Expr)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN106_TU2/LF_scatters.pdf", h=5,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN106, LFs_LNEN106_TU2, p1, p2, patchwork)

```

# LNEN112 - A2
```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN112"),c(1,22,34)]
#       sample_id   omics_group               cohort
# 364 LNEN112_TU1 WGS.Expr.Meth lungNENomicsCombined
# 365 LNEN112_TU2          Expr                 <NA>

LFs_LNEN112_TU2 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN112_TU2/LFs_319.Cordin.txt")
euclidean_LNEN112 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN112_TU1"),],LFs_LNEN112_TU2[which(rownames(LFs_LNEN112_TU2)=="LNEN112_TU2"),c(1,2,5)])
dist(euclidean_LNEN112) # 0.2478963

euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_LNEN112)[-2],
                               sample2=rownames(euclidean_LNEN112)[-1], 
                               dist = dist(euclidean_LNEN112)) )

# euclidean_LNEN112
#                 Factor1  Factor2   Factor5
# LNEN112_TU1 -0.16244841 1.828595 0.2900830
# LNEN112_TU2  0.06722752 1.773477 0.2148263

LFs_LNEN112_TU2$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN112_TU2), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = "LNEN112_TU2"
sample_id_tmp.original = "LNEN112_TU1"
LFs_tmp = LFs_LNEN112_TU2

arc_ks.LFs.noboot = k_fit_pch( t(LFs_tmp[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" )
tern_arc = as_tibble( t( arc_ks.LFs.noboot$S ) )

neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]),
  tibble(sample_id = sample_id_tmp,
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp][1])
)

# compute silhouette
LFs_tmp$archetype_k4_LF3_label[LFs_tmp$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmp$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) ,
                c(sample=sample_id_tmp,silhouette(as.numeric(as.factor(LFs_tmp$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmp[,c(1,2,5)]))[which(rownames(LFs_tmp)==sample_id_tmp),]) )


p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN112_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN112_TU1 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN112_TU2, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN112_TU2[rownames(LFs_LNEN112_TU2) == "LNEN112_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN112_TU2 (Expr)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN112_TU2/LF_scatters.pdf", h=5,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN112, LFs_LNEN112_TU2, p1, p2, patchwork)

```

# LNEN169 - A1
```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN169"),c(1,22,34)]
#       sample_id omics_group               cohort
# 467 LNEN169_TU1   Expr.Meth lungNENomicsCombined
# 468 LNEN169_TU2   Expr.Meth                 <NA>

LFs_LNEN169_TU2 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN169_TU2/LFs_319.Cordin.txt")
euclidean_LNEN169 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN169_TU1"),],LFs_LNEN169_TU2[which(rownames(LFs_LNEN169_TU2)=="LNEN169_TU2"),c(1,2,5)])
dist(euclidean_LNEN169) # 2.691463

euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_LNEN169)[-2],
                                sample2=rownames(euclidean_LNEN169)[-1], 
                                dist = dist(euclidean_LNEN169)) )

euclidean_LNEN169
#               Factor1   Factor2   Factor5
# LNEN169_TU1 -3.023792 -1.411315  1.077310
# LNEN169_TU2 -1.393050 -1.039165 -1.031281

LFs_LNEN169_TU2$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN169_TU2), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = "LNEN169_TU2"
sample_id_tmp.original = "LNEN169_TU1"
LFs_tmp = LFs_LNEN169_TU2

arc_ks.LFs.noboot = k_fit_pch( t(LFs_tmp[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" )
tern_arc = as_tibble( t( arc_ks.LFs.noboot$S ) )

neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]),
  tibble(sample_id = sample_id_tmp,
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp][1])
)

# compute silhouette
LFs_tmp$archetype_k4_LF3_label[LFs_tmp$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmp$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) ,
                c(sample=sample_id_tmp,silhouette(as.numeric(as.factor(LFs_tmp$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmp[,c(1,2,5)]))[which(rownames(LFs_tmp)==sample_id_tmp),]) )


p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN169_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN169_TU1 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN169_TU2, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN169_TU2[rownames(LFs_LNEN169_TU2) == "LNEN169_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN169_TU2 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(var_cli, aes(x=Factor1, y=Factor5, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor5") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN169_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN169_TU1 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p4 <- ggplot(LFs_LNEN169_TU2, aes(x=Factor1, y=Factor5, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor5") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN169_TU2[rownames(LFs_LNEN169_TU2) == "LNEN169_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN169_TU2 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + p4
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN169_TU2/LF_scatters.pdf", h=10,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN169, LFs_LNEN169_TU2, p1, p2, p3, p4, patchwork)

```

# LNEN251 - B
```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN251"),c(1,22,34)]
#       sample_id omics_group               cohort
# 554 LNEN251_TU1        Meth lungNENomicsCombined
# 555 LNEN251_TU2        Meth                 <NA>

LFs_LNEN251_TU2 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN251_TU2/LFs_319.Cordin.txt")
euclidean_LNEN251 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN251_TU1"),],LFs_LNEN251_TU2[which(rownames(LFs_LNEN251_TU2)=="LNEN251_TU2"),c(1,2,5)])
dist(euclidean_LNEN251) # 0.4055187

euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_LNEN251)[-2],
                                sample2=rownames(euclidean_LNEN251)[-1], 
                               dist = dist(euclidean_LNEN251)) )

euclidean_LNEN251
#              Factor1    Factor2   Factor5
# LNEN251_TU1 3.134391 -0.8826795 1.0213600
# LNEN251_TU2 2.900211 -0.8860905 0.6903112

LFs_LNEN251_TU2$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN251_TU2), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = "LNEN251_TU2"
sample_id_tmp.original = "LNEN251_TU1"
LFs_tmp = LFs_LNEN251_TU2

arc_ks.LFs.noboot = k_fit_pch( t(LFs_tmp[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" )
tern_arc = as_tibble( t( arc_ks.LFs.noboot$S ) )

neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]),
  tibble(sample_id = sample_id_tmp,
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp][1])
)

# compute silhouette
LFs_tmp$archetype_k4_LF3_label[LFs_tmp$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmp$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) ,
                c(sample=sample_id_tmp,silhouette(as.numeric(as.factor(LFs_tmp$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmp[,c(1,2,5)]))[which(rownames(LFs_tmp)==sample_id_tmp),]) )


p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN251_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN251_TU1 (Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN251_TU2, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN251_TU2[rownames(LFs_LNEN251_TU2) == "LNEN251_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN251_TU2 (Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN251_TU2/LF_scatters.pdf", h=5,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN251, LFs_LNEN251_TU2, p1, p2, patchwork)

```

# LNEN151 - A2
```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN151"),c(1,22,34)]
# sample_id omics_group               cohort
# 411 LNEN151_TU3   Expr.Meth lungNENomicsCombined
# 412 LNEN151_TU4   Expr.Meth                 <NA>
# 413 LNEN151_TU5   Expr.Meth                 <NA>
# 414 LNEN151_TU6        Expr                 <NA>
# 409 LNEN151_TU1        Meth                 <NA>
# 410 LNEN151_TU2        Meth                 <NA>

LFs_LNEN151_TU4 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN151_TU4/LFs_319.Cordin.txt") # flipped
LFs_LNEN151_TU5 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN151_TU5/LFs_319.Cordin.txt") # flipped
LFs_LNEN151_TU6 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN151_TU6/LFs_319.Cordin.txt") # flipped
LFs_LNEN151_TU1 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN151_TU1/LFs_319.Cordin.txt") # flipped
LFs_LNEN151_TU2 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN151_TU2/LFs_319.Cordin.txt") # flipped

colnames(LFs_LNEN151_TU4)[5] <- "Factor5_o"
LFs_LNEN151_TU4$Factor5 <- LFs_LNEN151_TU4$Factor5_o*-1

colnames(LFs_LNEN151_TU5)[5] <- "Factor5_o"
LFs_LNEN151_TU5$Factor5 <- LFs_LNEN151_TU5$Factor5_o*-1

colnames(LFs_LNEN151_TU6)[5] <- "Factor5_o"
LFs_LNEN151_TU6$Factor5 <- LFs_LNEN151_TU6$Factor5_o*-1

colnames(LFs_LNEN151_TU1)[5] <- "Factor5_o"
LFs_LNEN151_TU1$Factor5 <- LFs_LNEN151_TU1$Factor5_o*-1

colnames(LFs_LNEN151_TU2)[5] <- "Factor5_o"
LFs_LNEN151_TU2$Factor5 <- LFs_LNEN151_TU2$Factor5_o*-1

euclidean_LNEN151 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN151_TU3"),], LFs_LNEN151_TU4[which(rownames(LFs_LNEN151_TU4)=="LNEN151_TU4"),c(1,2,11)])
euclidean_LNEN151 <- rbind(euclidean_LNEN151, LFs_LNEN151_TU5[which(rownames(LFs_LNEN151_TU5)=="LNEN151_TU5"),c(1,2,11)])
euclidean_LNEN151 <- rbind(euclidean_LNEN151, LFs_LNEN151_TU6[which(rownames(LFs_LNEN151_TU6)=="LNEN151_TU6"),c(1,2,11)])
euclidean_LNEN151 <- rbind(euclidean_LNEN151, LFs_LNEN151_TU1[which(rownames(LFs_LNEN151_TU1)=="LNEN151_TU1"),c(1,2,11)])
euclidean_LNEN151 <- rbind(euclidean_LNEN151, LFs_LNEN151_TU2[which(rownames(LFs_LNEN151_TU2)=="LNEN151_TU2"),c(1,2,11)])

for(i in 1:(nrow(euclidean_LNEN151)-1) ) {
  for(j in (i+1):nrow(euclidean_LNEN151)){
  euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_LNEN151)[i],
                                sample2=rownames(euclidean_LNEN151)[j], 
                               dist = dist(euclidean_LNEN151[c(i,j),])) )
  }
}


euclidean_LNEN151
#                Factor1  Factor2     Factor5
# LNEN151_TU3 0.18702912 1.599550 -0.52647181
# LNEN151_TU4 0.13778694 2.512588  0.59726565
# LNEN151_TU5 0.12834002 2.656157  0.82973756
# LNEN151_TU6 0.45586089 2.040469  0.07263809
# LNEN151_TU1 0.11163824 2.161806  0.96197497
# LNEN151_TU2 0.08885049 2.082097  0.68343602

dist(euclidean_LNEN151) # 0.8637249
#             LNEN151_TU3 LNEN151_TU4 LNEN151_TU5 LNEN151_TU6 LNEN151_TU1
# LNEN151_TU4   1.4487407                                                
# LNEN151_TU5   1.7202227   0.2733941                                    
# LNEN151_TU6   0.7909572   0.7741455   1.0293398                        
# LNEN151_TU1   1.5928871   0.5067000   0.5120044   0.9613178            
# LNEN151_TU2   1.3062800   0.4417500   0.5937243   0.7137952   0.2906145

LFs_LNEN151_TU4$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN151_TU4), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN151_TU5$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN151_TU5), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN151_TU6$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN151_TU6), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN151_TU1$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN151_TU1), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN151_TU2$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN151_TU2), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})


# ParetoTI arc analysis
sample_id_tmp = c("LNEN151_TU4","LNEN151_TU5","LNEN151_TU6","LNEN151_TU1","LNEN151_TU2")
sample_id_tmp.original = "LNEN151_TU3"
LFs_tmpl = list(LFs_LNEN151_TU4,LFs_LNEN151_TU5,LFs_LNEN151_TU6,LFs_LNEN151_TU1,LFs_LNEN151_TU2)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN151_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN151_TU3 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN151_TU4, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN151_TU4[rownames(LFs_LNEN151_TU4) == "LNEN151_TU4",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN151_TU4 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(LFs_LNEN151_TU5, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN151_TU5[rownames(LFs_LNEN151_TU5) == "LNEN151_TU5",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN151_TU5 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p4 <- ggplot(LFs_LNEN151_TU6, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN151_TU6[rownames(LFs_LNEN151_TU6) == "LNEN151_TU6",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN151_TU6 (Expr)") + theme(plot.title = element_text(hjust = 0.5))
p5 <- ggplot(LFs_LNEN151_TU1, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN151_TU1[rownames(LFs_LNEN151_TU1) == "LNEN151_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN151_TU1 (Meth)") + theme(plot.title = element_text(hjust = 0.5))
p6 <- ggplot(LFs_LNEN151_TU2, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN151_TU2[rownames(LFs_LNEN151_TU2) == "LNEN151_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN151_TU2 (Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + p4 + p5 + p6 + plot_layout(ncol=3)
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN151_TU4/LF_scatters.pdf", h=10,w=19.5)
#patchwork
#dev.off() 

#rm(euclidean_LNEN151, LFs_LNEN151_TU1, LFs_LNEN151_TU2, LFs_LNEN151_TU4, LFs_LNEN151_TU5, LFs_LNEN151_TU6, p1, p2, p3, p4, p5, p6, patchwork)
```

#### LNEN153 - B

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN153"),c(1,22,34)]
#       sample_id omics_group               cohort
# 421 LNEN153_TU6   Expr.Meth lungNENomicsCombined
# 416 LNEN153_TU1   Expr.Meth                 <NA>
# 419 LNEN153_TU4   Expr.Meth                 <NA>
# 420 LNEN153_TU5   Expr.Meth                 <NA>
# 417 LNEN153_TU2        Meth                 <NA>
# 418 LNEN153_TU3        Meth                 <NA>

LFs_LNEN153_TU1 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN153_TU1/LFs_319.Cordin.txt") 
LFs_LNEN153_TU4 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN153_TU4/LFs_319.Cordin.txt") 
LFs_LNEN153_TU5 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN153_TU5/LFs_319.Cordin.txt") 
LFs_LNEN153_TU2 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN153_TU2/LFs_319.Cordin.txt") 
LFs_LNEN153_TU3 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN153_TU3/LFs_319.Cordin.txt") 

euclidean_LNEN153 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN153_TU6"),], LFs_LNEN153_TU1[which(rownames(LFs_LNEN153_TU1)=="LNEN153_TU1"),c(1,2,5)])
euclidean_LNEN153 <- rbind(euclidean_LNEN153, LFs_LNEN153_TU4[which(rownames(LFs_LNEN153_TU4)=="LNEN153_TU4"),c(1,2,5)])
euclidean_LNEN153 <- rbind(euclidean_LNEN153, LFs_LNEN153_TU5[which(rownames(LFs_LNEN153_TU5)=="LNEN153_TU5"),c(1,2,5)])
euclidean_LNEN153 <- rbind(euclidean_LNEN153, LFs_LNEN153_TU2[which(rownames(LFs_LNEN153_TU2)=="LNEN153_TU2"),c(1,2,5)])
euclidean_LNEN153 <- rbind(euclidean_LNEN153, LFs_LNEN153_TU3[which(rownames(LFs_LNEN153_TU3)=="LNEN153_TU3"),c(1,2,5)])

euclidean_LNEN153
#              Factor1    Factor2    Factor5
# LNEN153_TU6 2.616854 -0.7690419  0.2267082
# LNEN153_TU1 3.217612 -0.8824077  0.9118279
# LNEN153_TU4 2.491059 -0.8171627 -0.7361559
# LNEN153_TU5 3.204891 -0.8731523  0.9685949
# LNEN153_TU2 2.887255 -0.9152517  0.3930321
# LNEN153_TU3 3.136075 -0.9561720  0.6342727

dist(euclidean_LNEN153) # 0.838916
#             LNEN153_TU6 LNEN153_TU1 LNEN153_TU4 LNEN153_TU5 LNEN153_TU2
# LNEN153_TU1  0.91823229                                                
# LNEN153_TU4  0.97223823  1.80221708                                    
# LNEN153_TU5  0.95237723  0.05890643  1.84901769                        
# LNEN153_TU2  0.34951080  0.61592461  1.20069088  0.65873920            
# LNEN153_TU3  0.68608793  0.29854031  1.52100086  0.35128231  0.34897365

for(i in 1:(nrow(euclidean_LNEN153)-1) ) {
  for(j in (i+1):nrow(euclidean_LNEN153)){
  euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_LNEN153)[i],
                                sample2=rownames(euclidean_LNEN153)[j], 
                               dist = dist(euclidean_LNEN153[c(i,j),])) )
  }
}

LFs_LNEN153_TU1$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN153_TU1), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN153_TU4$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN153_TU4), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN153_TU5$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN153_TU5), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN153_TU2$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN153_TU2), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN153_TU3$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN153_TU3), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN153_TU1","LNEN153_TU4","LNEN153_TU5","LNEN153_TU2","LNEN153_TU3")
sample_id_tmp.original = "LNEN153_TU6"
LFs_tmpl = list(LFs_LNEN153_TU1,LFs_LNEN153_TU4,LFs_LNEN153_TU5,LFs_LNEN153_TU2,LFs_LNEN153_TU3)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN153_TU6",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN153_TU6 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN153_TU1, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN153_TU1[rownames(LFs_LNEN153_TU1) == "LNEN153_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN153_TU1 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(LFs_LNEN153_TU4, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN153_TU4[rownames(LFs_LNEN153_TU4) == "LNEN153_TU4",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN153_TU4 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p4 <- ggplot(LFs_LNEN153_TU5, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN153_TU5[rownames(LFs_LNEN153_TU5) == "LNEN153_TU5",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN153_TU5 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p5 <- ggplot(LFs_LNEN153_TU2, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN153_TU2[rownames(LFs_LNEN153_TU2) == "LNEN153_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN153_TU2 (Meth)") + theme(plot.title = element_text(hjust = 0.5))
p6 <- ggplot(LFs_LNEN153_TU3, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN153_TU3[rownames(LFs_LNEN153_TU3) == "LNEN153_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN153_TU3 (Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + p4 + p5 + p6 + plot_layout(ncol=3)
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN153_TU1/LF_scatters.pdf", h=10,w=19.5)
#patchwork
#dev.off() 

#rm(euclidean_LNEN153, LFs_LNEN153_TU1, LFs_LNEN153_TU2, LFs_LNEN153_TU3, LFs_LNEN153_TU4, LFs_LNEN153_TU5, p1, p2, p3, p4, p5, p6, patchwork)

```

#### LNEN154 - A2

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN154"),c(1,22,34)]
#          sample_id omics_group               cohort
# 425    LNEN154_TU3   Expr.Meth lungNENomicsCombined
# 422 LNEN154_TU1_R1   Expr.Meth                 <NA>
# 424    LNEN154_TU2   Expr.Meth                 <NA>
# 426    LNEN154_TU4   Expr.Meth                 <NA>
  

LFs_LNEN154_TU1_R1 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN154_TU1_R1/LFs_319.Cordin.txt") # flipped
LFs_LNEN154_TU2 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN154_TU2/LFs_319.Cordin.txt") # flipped
LFs_LNEN154_TU4 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN154_TU4/LFs_319.Cordin.txt") # flipped

colnames(LFs_LNEN154_TU1_R1)[5] <- "Factor5_o"
LFs_LNEN154_TU1_R1$Factor5 <- LFs_LNEN154_TU1_R1$Factor5_o*-1

colnames(LFs_LNEN154_TU2)[5] <- "Factor5_o"
LFs_LNEN154_TU2$Factor5 <- LFs_LNEN154_TU2$Factor5_o*-1

colnames(LFs_LNEN154_TU4)[5] <- "Factor5_o"
LFs_LNEN154_TU4$Factor5 <- LFs_LNEN154_TU4$Factor5_o*-1

euclidean_LNEN154 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN154_TU3"),], LFs_LNEN154_TU1_R1[which(rownames(LFs_LNEN154_TU1_R1)=="LNEN154_TU1_R1"),c(1,2,11)])
euclidean_LNEN154 <- rbind(euclidean_LNEN154, LFs_LNEN154_TU2[which(rownames(LFs_LNEN154_TU2)=="LNEN154_TU2"),c(1,2,11)])
euclidean_LNEN154 <- rbind(euclidean_LNEN154, LFs_LNEN154_TU4[which(rownames(LFs_LNEN154_TU4)=="LNEN154_TU4"),c(1,2,11)])

euclidean_LNEN154
#                    Factor1  Factor2     Factor5
# LNEN154_TU3    -0.09692267 1.621235 -0.45031635
# LNEN154_TU1_R1 -0.19219094 2.154526 -0.09478718
# LNEN154_TU2    -0.16171116 1.844299 -0.00704444
# LNEN154_TU4    -0.12327603 1.811622 -0.20931913

dist(euclidean_LNEN154) # 0.3928369
#                LNEN154_TU3 LNEN154_TU1_R1 LNEN154_TU2
# LNEN154_TU1_R1   0.6479794                           
# LNEN154_TU2      0.5004452      0.3238343            
# LNEN154_TU4      0.3082555      0.3680358   0.2084709

for(i in 1:(nrow(euclidean_LNEN154)-1) ) {
   for(j in (i+1):nrow(euclidean_LNEN154)){
   euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_LNEN154)[i],
                                 sample2=rownames(euclidean_LNEN154)[j], 
                                dist = dist(euclidean_LNEN154[c(i,j),])) )
   }
 }

LFs_LNEN154_TU1_R1$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN154_TU1_R1), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN154_TU2$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN154_TU2), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN154_TU4$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN154_TU4), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN154_TU1_R1","LNEN154_TU2","LNEN154_TU4")
sample_id_tmp.original = "LNEN154_TU3"
LFs_tmpl = list(LFs_LNEN154_TU1_R1,LFs_LNEN154_TU2,LFs_LNEN154_TU4)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}


p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN154_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN154_TU3 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN154_TU1_R1, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN154_TU1_R1[rownames(LFs_LNEN154_TU1_R1) == "LNEN154_TU1_R1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN154_TU1_R1 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(LFs_LNEN154_TU2, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN154_TU2[rownames(LFs_LNEN154_TU2) == "LNEN154_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN154_TU2 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p4 <- ggplot(LFs_LNEN154_TU4, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN154_TU4[rownames(LFs_LNEN154_TU4) == "LNEN154_TU4",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN154_TU4 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + p4 + plot_layout(ncol=2)
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN154_TU1_R1/LF_scatters.pdf", h=10,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN154, LFs_LNEN154_TU1_R1, LFs_LNEN154_TU2, LFs_LNEN154_TU4, p1, p2, p3, p4, patchwork)
```

#### LNEN155 - A2

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN155"),c(1,22,34)]
#       sample_id omics_group               cohort
# 433 LNEN155_TU7   Expr.Meth lungNENomicsCombined

# 428 LNEN155_TU2   Expr.Meth                 <NA>
# 429 LNEN155_TU3   Expr.Meth                 <NA>
# 430 LNEN155_TU4   Expr.Meth                 <NA>
# 427 LNEN155_TU1        Meth                 <NA>
# 431 LNEN155_TU5        Meth                 <NA>
# 432 LNEN155_TU6        Meth                 <NA>

LFs_LNEN155_TU2 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN155_TU2/LFs_319.Cordin.txt") 
LFs_LNEN155_TU3 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN155_TU3/LFs_319.Cordin.txt") 
LFs_LNEN155_TU4 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN155_TU4/LFs_319.Cordin.txt") 
LFs_LNEN155_TU1 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN155_TU1/LFs_319.Cordin.txt")
LFs_LNEN155_TU5 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN155_TU5/LFs_319.Cordin.txt")
LFs_LNEN155_TU6 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN155_TU6/LFs_319.Cordin.txt")

euclidean_LNEN155 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN155_TU7"),], LFs_LNEN155_TU2[which(rownames(LFs_LNEN155_TU2)=="LNEN155_TU2"),c(1,2,5)])
euclidean_LNEN155 <- rbind(euclidean_LNEN155, LFs_LNEN155_TU3[which(rownames(LFs_LNEN155_TU3)=="LNEN155_TU3"),c(1,2,5)])
euclidean_LNEN155 <- rbind(euclidean_LNEN155, LFs_LNEN155_TU4[which(rownames(LFs_LNEN155_TU4)=="LNEN155_TU4"),c(1,2,5)])
euclidean_LNEN155 <- rbind(euclidean_LNEN155, LFs_LNEN155_TU1[which(rownames(LFs_LNEN155_TU1)=="LNEN155_TU1"),c(1,2,5)])
euclidean_LNEN155 <- rbind(euclidean_LNEN155, LFs_LNEN155_TU5[which(rownames(LFs_LNEN155_TU5)=="LNEN155_TU5"),c(1,2,5)])
euclidean_LNEN155 <- rbind(euclidean_LNEN155, LFs_LNEN155_TU6[which(rownames(LFs_LNEN155_TU6)=="LNEN155_TU6"),c(1,2,5)])

euclidean_LNEN155
#                Factor1  Factor2    Factor5
# LNEN155_TU7 0.05969476 2.152267  0.3361232
# LNEN155_TU2 0.04307756 1.898517 -0.1537280
# LNEN155_TU3 0.01965783 2.012195  0.1089841
# LNEN155_TU4 0.02676578 2.210321  0.3764896
# LNEN155_TU1 0.01473765 1.908037  0.0310969
# LNEN155_TU5 0.06989313 1.929990  0.3512662
# LNEN155_TU6 0.03805946 2.375218  0.6340585

dist(euclidean_LNEN155) # 0.4016987
#             LNEN155_TU7 LNEN155_TU2 LNEN155_TU3 LNEN155_TU4 LNEN155_TU1 LNEN155_TU5
# LNEN155_TU2  0.55192369                                                            
# LNEN155_TU3  0.26984312  0.28720893                                                
# LNEN155_TU4  0.07800006  0.61532009  0.33296181                                    
# LNEN155_TU1  0.39333257  0.18722727  0.13015190  0.45914739                        
# LNEN155_TU5  0.22302550  0.50668421  0.26073335  0.28474824  0.32562627            
# LNEN155_TU6  0.37274742  0.92080246  0.63861367  0.30603978  0.76312821  0.52840585

for(i in 1:(nrow(euclidean_LNEN155)-1) ) {
    for(j in (i+1):nrow(euclidean_LNEN155)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_LNEN155)[i],
                                  sample2=rownames(euclidean_LNEN155)[j], 
                                 dist = dist(euclidean_LNEN155[c(i,j),])) )
    }
}

LFs_LNEN155_TU2$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN155_TU2), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN155_TU3$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN155_TU3), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN155_TU4$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN155_TU4), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN155_TU1$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN155_TU1), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN155_TU5$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN155_TU5), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN155_TU6$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN155_TU6), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN155_TU2","LNEN155_TU3","LNEN155_TU4","LNEN155_TU1","LNEN155_TU5","LNEN155_TU6")
sample_id_tmp.original = "LNEN155_TU7"
LFs_tmpl = list(LFs_LNEN155_TU2,LFs_LNEN155_TU3,LFs_LNEN155_TU4,LFs_LNEN155_TU1,LFs_LNEN155_TU5,LFs_LNEN155_TU6)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}


p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN155_TU7",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN155_TU7 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN155_TU2, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN155_TU2[rownames(LFs_LNEN155_TU2) == "LNEN155_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN155_TU2 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(LFs_LNEN155_TU3, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN155_TU3[rownames(LFs_LNEN155_TU3) == "LNEN155_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN155_TU3 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p4 <- ggplot(LFs_LNEN155_TU4, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN155_TU4[rownames(LFs_LNEN155_TU4) == "LNEN155_TU4",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN155_TU4 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p5 <- ggplot(LFs_LNEN155_TU1, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN155_TU1[rownames(LFs_LNEN155_TU1) == "LNEN155_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN155_TU1 (Meth)") + theme(plot.title = element_text(hjust = 0.5))
p6 <- ggplot(LFs_LNEN155_TU5, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN155_TU5[rownames(LFs_LNEN155_TU5) == "LNEN155_TU5",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN155_TU5 (Meth)") + theme(plot.title = element_text(hjust = 0.5))
p7 <- ggplot(LFs_LNEN155_TU6, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN155_TU6[rownames(LFs_LNEN155_TU6) == "LNEN155_TU6",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN155_TU6 (Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + p4 + p5 + p6 + p7 + plot_layout(ncol=4)
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN155_TU2/LF_scatters.pdf", h=10,w=26)
#patchwork
#dev.off() 

#rm(euclidean_LNEN155, LFs_LNEN155_TU1, LFs_LNEN155_TU2, LFs_LNEN155_TU3, LFs_LNEN155_TU4, LFs_LNEN155_TU5, LFs_LNEN155_TU6, p1, p2, p3, p4, p5, p6, p7, patchwork)
```

#### LNEN157

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN157"),c(1,22,34)]
#       sample_id omics_group               cohort
# 436 LNEN157_TU2   Expr.Meth lungNENomicsCombined

# 435 LNEN157_TU1   Expr.Meth                 <NA>
# 437 LNEN157_TU3   Expr.Meth                 <NA>
# 439 LNEN157_TU5   Expr.Meth                 <NA>
# 438 LNEN157_TU4        Meth                 <NA>

LFs_LNEN157_TU1 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN157_TU1/LFs_319.Cordin.txt") 
LFs_LNEN157_TU3 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN157_TU3/LFs_319.Cordin.txt") 
LFs_LNEN157_TU5 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN157_TU5/LFs_319.Cordin.txt") 
LFs_LNEN157_TU4 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN157_TU4/LFs_319.Cordin.txt")

euclidean_LNEN157 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN157_TU2"),], LFs_LNEN157_TU1[which(rownames(LFs_LNEN157_TU1)=="LNEN157_TU1"),c(1,2,5)])
euclidean_LNEN157 <- rbind(euclidean_LNEN157, LFs_LNEN157_TU3[which(rownames(LFs_LNEN157_TU3)=="LNEN157_TU3"),c(1,2,5)])
euclidean_LNEN157 <- rbind(euclidean_LNEN157, LFs_LNEN157_TU5[which(rownames(LFs_LNEN157_TU5)=="LNEN157_TU5"),c(1,2,5)])
euclidean_LNEN157 <- rbind(euclidean_LNEN157, LFs_LNEN157_TU4[which(rownames(LFs_LNEN157_TU4)=="LNEN157_TU4"),c(1,2,5)])

euclidean_LNEN157
#               Factor1    Factor2   Factor5
# LNEN157_TU2 -2.174203 -0.5366898 0.4062333
# LNEN157_TU1 -2.092783 -0.5339561 0.8477550
# LNEN157_TU3 -1.892114 -0.6174406 0.4019839
# LNEN157_TU5 -2.035416 -0.5426276 0.9237534
# LNEN157_TU4 -2.088647 -0.5606598 0.7947278

dist(euclidean_LNEN157)
#             LNEN157_TU2 LNEN157_TU1 LNEN157_TU3 LNEN157_TU5
# LNEN157_TU1  0.44897452                                    
# LNEN157_TU3  0.29344983  0.49593299                        
# LNEN157_TU5  0.53583960  0.09561334  0.54623782            
# LNEN157_TU4  0.39852530  0.05951536  0.44282835  0.14073474

for(i in 1:(nrow(euclidean_LNEN157)-1) ) {
    for(j in (i+1):nrow(euclidean_LNEN157)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_LNEN157)[i],
                                  sample2=rownames(euclidean_LNEN157)[j], 
                                 dist = dist(euclidean_LNEN157[c(i,j),])) )
    }
}

LFs_LNEN157_TU1$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN157_TU1), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN157_TU3$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN157_TU3), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN157_TU5$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN157_TU5), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN157_TU4$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN157_TU4), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN157_TU1","LNEN157_TU3","LNEN157_TU5","LNEN157_TU4")
sample_id_tmp.original = "LNEN157_TU2"
LFs_tmpl = list(LFs_LNEN157_TU1,LFs_LNEN157_TU3,LFs_LNEN157_TU5,LFs_LNEN157_TU4)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN157_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN157_TU2 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN157_TU1, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN157_TU1[rownames(LFs_LNEN157_TU1) == "LNEN157_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN157_TU1 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(LFs_LNEN157_TU3, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN157_TU3[rownames(LFs_LNEN157_TU3) == "LNEN157_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN157_TU3 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p4 <- ggplot(LFs_LNEN157_TU5, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN157_TU5[rownames(LFs_LNEN157_TU5) == "LNEN157_TU5",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN157_TU5 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p5 <- ggplot(LFs_LNEN157_TU4, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN157_TU4[rownames(LFs_LNEN157_TU4) == "LNEN157_TU4",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN157_TU4 (Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + p4 + p5 + plot_layout(ncol=3)
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN157_TU1/LF_scatters.pdf", h=10,w=19.5)
#patchwork
#dev.off() 

#rm(euclidean_LNEN157, LFs_LNEN157_TU1, LFs_LNEN157_TU3, LFs_LNEN157_TU4, LFs_LNEN157_TU5, p1, p2, p3, p4, p5, patchwork)
```

#### LNEN159

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN159"),c(1,22,34)]
#       sample_id omics_group               cohort
# 442 LNEN159_TU2   Expr.Meth lungNENomicsCombined

# 441 LNEN159_TU1   Expr.Meth                 <NA>
# 443 LNEN159_TU3   Expr.Meth                 <NA>

LFs_LNEN159_TU1 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN159_TU1/LFs_319.Cordin.txt") 
LFs_LNEN159_TU3 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN159_TU3/LFs_319.Cordin.txt") 

euclidean_LNEN159 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN159_TU2"),], LFs_LNEN159_TU1[which(rownames(LFs_LNEN159_TU1)=="LNEN159_TU1"),c(1,2,5)])
euclidean_LNEN159 <- rbind(euclidean_LNEN159, LFs_LNEN159_TU3[which(rownames(LFs_LNEN159_TU3)=="LNEN159_TU3"),c(1,2,5)])

euclidean_LNEN159
#              Factor1   Factor2   Factor5
# LNEN159_TU2 3.131401 -1.166394 1.0671597
# LNEN159_TU1 3.029650 -1.105893 1.0406189
# LNEN159_TU3 2.927450 -1.108275 0.8003782

dist(euclidean_LNEN159) # 0.2410688
#             LNEN159_TU2 LNEN159_TU1
# LNEN159_TU1   0.1213179            
# LNEN159_TU3   0.3408022   0.2610863

for(i in 1:(nrow(euclidean_LNEN159)-1) ) {
    for(j in (i+1):nrow(euclidean_LNEN159)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_LNEN159)[i],
                                  sample2=rownames(euclidean_LNEN159)[j], 
                                 dist = dist(euclidean_LNEN159[c(i,j),])) )
    }
}

LFs_LNEN159_TU1$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN159_TU1), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN159_TU3$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN159_TU3), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN159_TU1","LNEN159_TU3")
sample_id_tmp.original = "LNEN159_TU2"
LFs_tmpl = list(LFs_LNEN159_TU1,LFs_LNEN159_TU3)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN159_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN159_TU2 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN159_TU1, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN159_TU1[rownames(LFs_LNEN159_TU1) == "LNEN159_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN159_TU1 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(LFs_LNEN159_TU3, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN159_TU3[rownames(LFs_LNEN159_TU3) == "LNEN159_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN159_TU3 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + plot_layout(ncol=3)
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN159_TU1/LF_scatters.pdf", h=5,w=19.5)
#patchwork
#dev.off() 

#rm(euclidean_LNEN159, LFs_LNEN159_TU1, LFs_LNEN159_TU3, p1, p2, p3, patchwork)

```

#### LNEN164

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN164"),c(1,22,34)]
#       sample_id omics_group               cohort
# 448 LNEN164_TU2   Expr.Meth lungNENomicsCombined

# 447 LNEN164_TU1   Expr.Meth                 <NA>
# 449 LNEN164_TU3        Meth                 <NA>
# 450 LNEN164_TU4        Meth                 <NA>
  
LFs_LNEN164_TU1 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN164_TU1/LFs_319.Cordin.txt") 
LFs_LNEN164_TU3 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN164_TU3/LFs_319.Cordin.txt") 
LFs_LNEN164_TU4 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN164_TU4/LFs_319.Cordin.txt") 

euclidean_LNEN164 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN164_TU2"),], LFs_LNEN164_TU1[which(rownames(LFs_LNEN164_TU1)=="LNEN164_TU1"),c(1,2,5)])
euclidean_LNEN164 <- rbind(euclidean_LNEN164, LFs_LNEN164_TU3[which(rownames(LFs_LNEN164_TU3)=="LNEN164_TU3"),c(1,2,5)])
euclidean_LNEN164 <- rbind(euclidean_LNEN164, LFs_LNEN164_TU4[which(rownames(LFs_LNEN164_TU4)=="LNEN164_TU4"),c(1,2,5)])

euclidean_LNEN164
#              Factor1    Factor2   Factor5
# LNEN164_TU2 2.991899 -1.1193699 0.8354698
# LNEN164_TU1 3.082568 -1.1076071 0.8708016
# LNEN164_TU3 2.945693 -1.0207584 0.4639338
# LNEN164_TU4 2.955981 -0.9841607 0.4928101

dist(euclidean_LNEN164) # 0.2930525
#             LNEN164_TU2 LNEN164_TU1 LNEN164_TU3
# LNEN164_TU1  0.09801760                        
# LNEN164_TU3  0.38716696  0.43797123            
# LNEN164_TU4  0.37011789  0.41730155  0.04773984

for(i in 1:(nrow(euclidean_LNEN164)-1) ) {
    for(j in (i+1):nrow(euclidean_LNEN164)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_LNEN164)[i],
                                  sample2=rownames(euclidean_LNEN164)[j], 
                                 dist = dist(euclidean_LNEN164[c(i,j),])) )
    }
}

LFs_LNEN164_TU1$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN164_TU1), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN164_TU3$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN164_TU3), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN164_TU4$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN164_TU4), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN164_TU1","LNEN164_TU3","LNEN164_TU4")
sample_id_tmp.original = "LNEN164_TU2"
LFs_tmpl = list(LFs_LNEN164_TU1,LFs_LNEN164_TU3,LFs_LNEN164_TU4)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN164_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN164_TU2 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN164_TU1, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN164_TU1[rownames(LFs_LNEN164_TU1) == "LNEN164_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN164_TU1 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(LFs_LNEN164_TU3, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN164_TU3[rownames(LFs_LNEN164_TU3) == "LNEN164_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN164_TU3 (Meth)") + theme(plot.title = element_text(hjust = 0.5))
p4 <- ggplot(LFs_LNEN164_TU4, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN164_TU4[rownames(LFs_LNEN164_TU4) == "LNEN164_TU4",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN164_TU4 (Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + p4 + plot_layout(ncol=2)
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN164_TU1/LF_scatters.pdf", h=10,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN164, LFs_LNEN164_TU1, LFs_LNEN164_TU3, LFs_LNEN164_TU4, p1, p2, p3, p4, patchwork)

```

#### LNEN165

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN165"),c(1,22,34)]
#       sample_id omics_group               cohort
# 452 LNEN165_TU2   Expr.Meth lungNENomicsCombined

# 453 LNEN165_TU3   Expr.Meth                 <NA>
# 454 LNEN165_TU4   Expr.Meth                 <NA>
# 451 LNEN165_TU1        Meth                 <NA>
  
LFs_LNEN165_TU3 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN165_TU3/LFs_319.Cordin.txt") 
LFs_LNEN165_TU4 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN165_TU4/LFs_319.Cordin.txt") 
LFs_LNEN165_TU1 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN165_TU1/LFs_319.Cordin.txt") 

euclidean_LNEN165 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN165_TU2"),], LFs_LNEN165_TU3[which(rownames(LFs_LNEN165_TU3)=="LNEN165_TU3"),c(1,2,5)])
euclidean_LNEN165 <- rbind(euclidean_LNEN165, LFs_LNEN165_TU4[which(rownames(LFs_LNEN165_TU4)=="LNEN165_TU4"),c(1,2,5)])
euclidean_LNEN165 <- rbind(euclidean_LNEN165, LFs_LNEN165_TU1[which(rownames(LFs_LNEN165_TU1)=="LNEN165_TU1"),c(1,2,5)])

euclidean_LNEN165
#                Factor1  Factor2      Factor5
# LNEN165_TU2 -0.1800322 2.011110  0.461676563
# LNEN165_TU3 -0.1554046 2.071847  0.567892707
# LNEN165_TU4 -0.1475664 1.667695 -0.008841557
# LNEN165_TU1 -0.1787622 1.861015  0.525064016

dist(euclidean_LNEN165) # 0.3934229
#             LNEN165_TU2 LNEN165_TU3 LNEN165_TU4
# LNEN165_TU3   0.1248091                        
# LNEN165_TU4   0.5834172   0.7042889            
# LNEN165_TU1   0.1629363   0.2164024   0.5686836

for(i in 1:(nrow(euclidean_LNEN165)-1) ) {
    for(j in (i+1):nrow(euclidean_LNEN165)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_LNEN165)[i],
                                  sample2=rownames(euclidean_LNEN165)[j], 
                                 dist = dist(euclidean_LNEN165[c(i,j),])) )
    }
}

LFs_LNEN165_TU3$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN165_TU3), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN165_TU4$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN165_TU4), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN165_TU1$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN165_TU1), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN165_TU3","LNEN165_TU4","LNEN165_TU1")
sample_id_tmp.original = "LNEN165_TU2"
LFs_tmpl = list(LFs_LNEN165_TU3,LFs_LNEN165_TU4,LFs_LNEN165_TU1)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN165_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN165_TU2 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN165_TU3, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN165_TU3[rownames(LFs_LNEN165_TU3) == "LNEN165_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN165_TU3 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(LFs_LNEN165_TU4, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN165_TU4[rownames(LFs_LNEN165_TU4) == "LNEN165_TU4",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN165_TU4 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p4 <- ggplot(LFs_LNEN165_TU1, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN165_TU1[rownames(LFs_LNEN165_TU1) == "LNEN165_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN165_TU1 (Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + p4 + plot_layout(ncol=2)
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN165_TU3/LF_scatters.pdf", h=10,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN165, LFs_LNEN165_TU1, LFs_LNEN165_TU3, LFs_LNEN165_TU4, p1, p2, p3, p4, #patchwork)

```

#### LNEN166 - A2

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN166"),c(1,22,34)]
#       sample_id omics_group               cohort
# 456 LNEN166_TU2   Expr.Meth lungNENomicsCombined

# 455 LNEN166_TU1   Expr.Meth                 <NA>
# 458 LNEN166_TU4   Expr.Meth                 <NA>
# 457 LNEN166_TU3        Meth                 <NA>

LFs_LNEN166_TU1 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN166_TU1/LFs_319.Cordin.txt") 
LFs_LNEN166_TU4 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN166_TU4/LFs_319.Cordin.txt") 
LFs_LNEN166_TU3 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN166_TU3/LFs_319.Cordin.txt") 

euclidean_LNEN166 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN166_TU2"),], LFs_LNEN166_TU1[which(rownames(LFs_LNEN166_TU1)=="LNEN166_TU1"),c(1,2,5)])
euclidean_LNEN166 <- rbind(euclidean_LNEN166, LFs_LNEN166_TU4[which(rownames(LFs_LNEN166_TU4)=="LNEN166_TU4"),c(1,2,5)])
euclidean_LNEN166 <- rbind(euclidean_LNEN166, LFs_LNEN166_TU3[which(rownames(LFs_LNEN166_TU3)=="LNEN166_TU3"),c(1,2,5)])

euclidean_LNEN166
#                Factor1  Factor2    Factor5
# LNEN166_TU2 -0.2368875 1.805157 -0.2494893
# LNEN166_TU1 -0.3327595 2.117360 -0.2573421
# LNEN166_TU4 -0.2532519 1.432056 -0.8347714
# LNEN166_TU3 -0.2702141 1.277740 -0.7375569

dist(euclidean_LNEN166) 
#             LNEN166_TU2 LNEN166_TU1 LNEN166_TU4
# LNEN166_TU1   0.3266867                        
# LNEN166_TU4   0.6942814   0.8996596            
# LNEN166_TU3   0.7193671   0.9692679   0.1831719

euclidean_tmp = euclidean_LNEN166
for(i in 1:(nrow(euclidean_tmp)-1) ) {
    for(j in (i+1):nrow(euclidean_tmp)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_tmp)[i],
                                  sample2=rownames(euclidean_tmp)[j], 
                                 dist = dist(euclidean_tmp[c(i,j),])) )
    }
}

LFs_LNEN166_TU1$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN166_TU1), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN166_TU4$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN166_TU4), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN166_TU3$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN166_TU3), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN166_TU1","LNEN166_TU4","LNEN166_TU3")
sample_id_tmp.original = "LNEN166_TU2"
LFs_tmpl = list(LFs_LNEN166_TU1,LFs_LNEN166_TU4,LFs_LNEN166_TU3)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}


p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN166_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN166_TU2 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN166_TU1, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN166_TU1[rownames(LFs_LNEN166_TU1) == "LNEN166_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN166_TU1 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(LFs_LNEN166_TU4, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN166_TU4[rownames(LFs_LNEN166_TU4) == "LNEN166_TU4",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN166_TU4 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p4 <- ggplot(LFs_LNEN166_TU3, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN166_TU3[rownames(LFs_LNEN166_TU3) == "LNEN166_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN166_TU3 (Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + p4 + plot_layout(ncol=2)
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN166_TU1/LF_scatters.pdf", h=10,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN166, LFs_LNEN166_TU1, LFs_LNEN166_TU4, LFs_LNEN166_TU3, p1, p2, p3, p4, #patchwork)

```

#### LNEN167 - B

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN167"),c(1,22,34)]
# sample_id omics_group               cohort
# 460 LNEN167_TU2   Expr.Meth lungNENomicsCombined

# 459 LNEN167_TU1        Meth                 <NA>
# 461 LNEN167_TU3        Meth                 <NA>

LFs_LNEN167_TU1 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN167_TU1/LFs_319.Cordin.txt") # flipped
LFs_LNEN167_TU3 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN167_TU3/LFs_319.Cordin.txt") # flipped

colnames(LFs_LNEN167_TU1)[5] <- "Factor5_o"
LFs_LNEN167_TU1$Factor5 <- LFs_LNEN167_TU1$Factor5_o*-1

colnames(LFs_LNEN167_TU3)[5] <- "Factor5_o"
LFs_LNEN167_TU3$Factor5 <- LFs_LNEN167_TU3$Factor5_o*-1

euclidean_LNEN167 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN167_TU2"),], LFs_LNEN167_TU1[which(rownames(LFs_LNEN167_TU1)=="LNEN167_TU1"),c(1,2,11)])
euclidean_LNEN167 <- rbind(euclidean_LNEN167, LFs_LNEN167_TU3[which(rownames(LFs_LNEN167_TU3)=="LNEN167_TU3"),c(1,2,11)])

euclidean_LNEN167
#              Factor1    Factor2      Factor5
# LNEN167_TU2 2.152447 -0.9144282 -0.899135426
# LNEN167_TU1 2.697893 -1.0926855 -0.002870303
# LNEN167_TU3 2.707837 -1.0856307  0.014541148

dist(euclidean_LNEN167) 
#             LNEN167_TU2 LNEN167_TU1
# LNEN167_TU1  1.06422650            
# LNEN167_TU3  1.08285434  0.02125603

euclidean_tmp = euclidean_LNEN167
for(i in 1:(nrow(euclidean_tmp)-1) ) {
    for(j in (i+1):nrow(euclidean_tmp)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_tmp)[i],
                                  sample2=rownames(euclidean_tmp)[j], 
                                 dist = dist(euclidean_tmp[c(i,j),])) )
    }
}

LFs_LNEN167_TU1$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN167_TU1), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN167_TU3$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN167_TU3), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})


# ParetoTI arc analysis
sample_id_tmp = c("LNEN167_TU1","LNEN167_TU3")
sample_id_tmp.original = "LNEN167_TU2"
LFs_tmpl = list(LFs_LNEN167_TU1,LFs_LNEN167_TU3)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN167_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN167_TU2 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN167_TU1, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN167_TU1[rownames(LFs_LNEN167_TU1) == "LNEN167_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN167_TU1 (Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(LFs_LNEN167_TU3, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN167_TU3[rownames(LFs_LNEN167_TU3) == "LNEN167_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN167_TU3 (Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + plot_layout(ncol=2)
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN167_TU1/LF_scatters.pdf", h=10,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN167, LFs_LNEN167_TU1, LFs_LNEN167_TU3, p1, p2, p3, #patchwork)

```

#### LNEN168 - A2

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN168"),c(1,22,34)]
#       sample_id omics_group               cohort
# 462 LNEN168_TU1   Expr.Meth lungNENomicsCombined

# 463 LNEN168_TU2   Expr.Meth                 <NA>
# 464 LNEN168_TU3   Expr.Meth                 <NA>
# 465 LNEN168_TU4   Expr.Meth                 <NA>
# 466 LNEN168_TU5        Meth                 <NA>
  
LFs_LNEN168_TU2 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN168_TU2/LFs_319.Cordin.txt") # flipped 
LFs_LNEN168_TU3 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN168_TU3/LFs_319.Cordin.txt") 
LFs_LNEN168_TU4 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN168_TU4/LFs_319.Cordin.txt") 
LFs_LNEN168_TU5 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN168_TU5/LFs_319.Cordin.txt") 

colnames(LFs_LNEN168_TU2)[5] <- "Factor5_o"
LFs_LNEN168_TU2$Factor5 <- LFs_LNEN168_TU2$Factor5_o*-1

euclidean_LNEN168 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN168_TU1"),], LFs_LNEN168_TU2[which(rownames(LFs_LNEN168_TU2)=="LNEN168_TU2"),c(1,2,11)])
euclidean_LNEN168 <- rbind(euclidean_LNEN168, LFs_LNEN168_TU3[which(rownames(LFs_LNEN168_TU3)=="LNEN168_TU3"),c(1,2,5)])
euclidean_LNEN168 <- rbind(euclidean_LNEN168, LFs_LNEN168_TU4[which(rownames(LFs_LNEN168_TU4)=="LNEN168_TU4"),c(1,2,5)])
euclidean_LNEN168 <- rbind(euclidean_LNEN168, LFs_LNEN168_TU5[which(rownames(LFs_LNEN168_TU5)=="LNEN168_TU5"),c(1,2,5)])

euclidean_LNEN168
#                  Factor1  Factor2     Factor5
# LNEN168_TU1  0.197434602 2.121624  0.43556598
# LNEN168_TU2  0.053748839 2.188145  0.36790251
# LNEN168_TU3  0.057235786 1.969958 -0.03244854
# LNEN168_TU4  0.017431304 2.118292  0.01023666
# LNEN168_TU5 -0.005276224 1.172512 -1.30931923

dist(euclidean_LNEN168) 
#             LNEN168_TU1 LNEN168_TU2 LNEN168_TU3 LNEN168_TU4
# LNEN168_TU2   0.1721888                                    
# LNEN168_TU3   0.5115621   0.4559590                        
# LNEN168_TU4   0.4618629   0.3662284   0.1594035            
# LNEN168_TU5   1.9966295   1.9616490   1.5067271   1.6236513

euclidean_tmp = euclidean_LNEN168
for(i in 1:(nrow(euclidean_tmp)-1) ) {
    for(j in (i+1):nrow(euclidean_tmp)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_tmp)[i],
                                  sample2=rownames(euclidean_tmp)[j], 
                                 dist = dist(euclidean_tmp[c(i,j),])) )
    }
}

LFs_LNEN168_TU2$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN168_TU2), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN168_TU3$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN168_TU3), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN168_TU4$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN168_TU4), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN168_TU5$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN168_TU5), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})


# ParetoTI arc analysis
sample_id_tmp = c("LNEN168_TU2","LNEN168_TU3","LNEN168_TU4","LNEN168_TU5")
sample_id_tmp.original = "LNEN168_TU1"
LFs_tmpl = list(LFs_LNEN168_TU2,LFs_LNEN168_TU3,LFs_LNEN168_TU4,LFs_LNEN168_TU5)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN168_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN168_TU1 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN168_TU2, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN168_TU2[rownames(LFs_LNEN168_TU2) == "LNEN168_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN168_TU2 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(LFs_LNEN168_TU3, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN168_TU3[rownames(LFs_LNEN168_TU3) == "LNEN168_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN168_TU3 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p4 <- ggplot(LFs_LNEN168_TU4, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN168_TU4[rownames(LFs_LNEN168_TU4) == "LNEN168_TU4",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN168_TU4 (Exp.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p5 <- ggplot(LFs_LNEN168_TU5, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN168_TU5[rownames(LFs_LNEN168_TU5) == "LNEN168_TU5",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN168_TU5 (Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + p4 + p5 + plot_layout(ncol=3)
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN168_TU2/LF_scatters.pdf", h=10,w=19.5)
#patchwork
#dev.off() 

#rm(euclidean_LNEN168, LFs_LNEN168_TU2, LFs_LNEN168_TU3, LFs_LNEN168_TU4,  LFs_LNEN168_TU5, p1, p2, p3, p4, p5, #patchwork)

```

#### LNEN170 - B

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN170"),c(1,22,34)]
#       sample_id omics_group               cohort
# 472 LNEN170_TU4   Expr.Meth lungNENomicsCombined

# 469 LNEN170_TU1   Expr.Meth                 <NA>
# 470 LNEN170_TU2   Expr.Meth                 <NA>
# 474 LNEN170_TU6   Expr.Meth                 <NA>
# 471 LNEN170_TU3        Meth                 <NA>
# 473 LNEN170_TU5        Meth                 <NA>
  
LFs_LNEN170_TU1 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN170_TU1/LFs_319.Cordin.txt") # flipped
LFs_LNEN170_TU2 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN170_TU2/LFs_319.Cordin.txt") # flipped
LFs_LNEN170_TU6 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN170_TU6/LFs_319.Cordin.txt") 
LFs_LNEN170_TU3 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN170_TU3/LFs_319.Cordin.txt") 
LFs_LNEN170_TU5 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN170_TU5/LFs_319.Cordin.txt") 

colnames(LFs_LNEN170_TU1)[5] <- "Factor5_o"
LFs_LNEN170_TU1$Factor5 <- LFs_LNEN170_TU1$Factor5_o*-1

colnames(LFs_LNEN170_TU2)[5] <- "Factor5_o"
LFs_LNEN170_TU2$Factor5 <- LFs_LNEN170_TU2$Factor5_o*-1

euclidean_LNEN170 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN170_TU4"),], LFs_LNEN170_TU1[which(rownames(LFs_LNEN170_TU1)=="LNEN170_TU1"),c(1,2,11)])
euclidean_LNEN170 <- rbind(euclidean_LNEN170, LFs_LNEN170_TU2[which(rownames(LFs_LNEN170_TU2)=="LNEN170_TU2"),c(1,2,11)])
euclidean_LNEN170 <- rbind(euclidean_LNEN170, LFs_LNEN170_TU6[which(rownames(LFs_LNEN170_TU6)=="LNEN170_TU6"),c(1,2,5)])
euclidean_LNEN170 <- rbind(euclidean_LNEN170, LFs_LNEN170_TU3[which(rownames(LFs_LNEN170_TU3)=="LNEN170_TU3"),c(1,2,5)])
euclidean_LNEN170 <- rbind(euclidean_LNEN170, LFs_LNEN170_TU5[which(rownames(LFs_LNEN170_TU5)=="LNEN170_TU5"),c(1,2,5)])

euclidean_LNEN170
#               Factor1    Factor2    Factor5
# LNEN170_TU4 0.8863702 -0.9373288  0.2367831
# LNEN170_TU1 0.8519262 -0.9291443  0.1293183
# LNEN170_TU2 0.8744142 -0.9436859  0.0683883
# LNEN170_TU6 0.8573143 -0.9136524  0.1575956
# LNEN170_TU3 0.7436790 -0.9241585 -0.0359560
# LNEN170_TU5 0.7955388 -1.0011621  0.1717895

dist(euclidean_LNEN170) 
#             LNEN170_TU4 LNEN170_TU1 LNEN170_TU2 LNEN170_TU6 LNEN170_TU3
# LNEN170_TU1  0.11314623                                                
# LNEN170_TU2  0.16893835  0.06655546                                    
# LNEN170_TU6  0.08760977  0.03269008  0.09566800                        
# LNEN170_TU3  0.30809229  0.19763069  0.16840646  0.22469001            
# LNEN170_TU5  0.12864380  0.10084599  0.14218525  0.10805391  0.22754598

euclidean_tmp = euclidean_LNEN170
for(i in 1:(nrow(euclidean_tmp)-1) ) {
    for(j in (i+1):nrow(euclidean_tmp)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_tmp)[i],
                                  sample2=rownames(euclidean_tmp)[j], 
                                 dist = dist(euclidean_tmp[c(i,j),])) )
    }
}

LFs_LNEN170_TU1$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN170_TU1), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN170_TU2$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN170_TU2), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN170_TU6$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN170_TU6), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN170_TU3$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN170_TU3), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN170_TU5$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN170_TU5), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN170_TU1","LNEN170_TU2","LNEN170_TU6","LNEN170_TU3","LNEN170_TU5")
sample_id_tmp.original = "LNEN170_TU4"
LFs_tmpl = list(LFs_LNEN170_TU1,LFs_LNEN170_TU2,LFs_LNEN170_TU6,LFs_LNEN170_TU3,LFs_LNEN170_TU5)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN170_TU4",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN170_TU4 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN170_TU1, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN170_TU1[rownames(LFs_LNEN170_TU1) == "LNEN170_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN170_TU1 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(LFs_LNEN170_TU2, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN170_TU2[rownames(LFs_LNEN170_TU2) == "LNEN170_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN170_TU2 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p4 <- ggplot(LFs_LNEN170_TU6, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN170_TU6[rownames(LFs_LNEN170_TU6) == "LNEN170_TU6",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN170_TU6 (Exp.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p5 <- ggplot(LFs_LNEN170_TU3, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN170_TU3[rownames(LFs_LNEN170_TU3) == "LNEN170_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN170_TU3 (Meth)") + theme(plot.title = element_text(hjust = 0.5))
p6 <- ggplot(LFs_LNEN170_TU5, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN170_TU5[rownames(LFs_LNEN170_TU5) == "LNEN170_TU5",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN170_TU5 (Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + p4 + p5 + p6 + plot_layout(ncol=3)
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN170_TU1/LF_scatters.pdf", h=10,w=19.5)
#patchwork
#dev.off() 

#rm(euclidean_LNEN170, LFs_LNEN170_TU1, LFs_LNEN170_TU2, LFs_LNEN170_TU6,  LFs_LNEN170_TU3, LFs_LNEN170_TU5, p1, p2, p3, p4, p5, p6, #patchwork)

```

#### LNEN171 - A1

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN171"),c(1,22,34)]
#          sample_id omics_group               cohort
# 475 LNEN171_TU1_R1   Expr.Meth lungNENomicsCombined

# 478    LNEN171_TU3   Expr.Meth                 <NA>
# 479    LNEN171_TU4   Expr.Meth                 <NA>
# 477    LNEN171_TU2        Meth                 <NA>

LFs_LNEN171_TU3 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN171_TU3/LFs_319.Cordin.txt") # flipped
LFs_LNEN171_TU4 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN171_TU4/LFs_319.Cordin.txt") # flipped
LFs_LNEN171_TU2 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN171_TU2/LFs_319.Cordin.txt") # flipped

colnames(LFs_LNEN171_TU3)[5] <- "Factor5_o"
LFs_LNEN171_TU3$Factor5 <- LFs_LNEN171_TU3$Factor5_o*-1

colnames(LFs_LNEN171_TU4)[5] <- "Factor5_o"
LFs_LNEN171_TU4$Factor5 <- LFs_LNEN171_TU4$Factor5_o*-1

colnames(LFs_LNEN171_TU2)[5] <- "Factor5_o"
LFs_LNEN171_TU2$Factor5 <- LFs_LNEN171_TU2$Factor5_o*-1

euclidean_LNEN171 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN171_TU1_R1"),], LFs_LNEN171_TU3[which(rownames(LFs_LNEN171_TU3)=="LNEN171_TU3"),c(1,2,11)])
euclidean_LNEN171 <- rbind(euclidean_LNEN171, LFs_LNEN171_TU4[which(rownames(LFs_LNEN171_TU4)=="LNEN171_TU4"),c(1,2,11)])
euclidean_LNEN171 <- rbind(euclidean_LNEN171, LFs_LNEN171_TU2[which(rownames(LFs_LNEN171_TU2)=="LNEN171_TU2"),c(1,2,11)])

euclidean_LNEN171
#                  Factor1    Factor2      Factor5
# LNEN171_TU1_R1 -2.231186 -0.9884308  1.699155930
# LNEN171_TU3    -1.804068 -0.9408011  0.600139785
# LNEN171_TU4    -2.267979 -0.9867520  1.503675164
# LNEN171_TU2    -1.375895 -0.8030732 -0.004053191

dist(euclidean_LNEN171) 
#             LNEN171_TU1_R1 LNEN171_TU3 LNEN171_TU4
# LNEN171_TU3      1.1800573                        
# LNEN171_TU4      0.1989201   1.0167107            
# LNEN171_TU2      1.9148897   0.7532266   1.7614755

euclidean_tmp = euclidean_LNEN171
for(i in 1:(nrow(euclidean_tmp)-1) ) {
    for(j in (i+1):nrow(euclidean_tmp)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_tmp)[i],
                                  sample2=rownames(euclidean_tmp)[j], 
                                 dist = dist(euclidean_tmp[c(i,j),])) )
    }
}

LFs_LNEN171_TU3$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN171_TU3), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN171_TU4$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN171_TU4), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN171_TU2$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN171_TU2), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})


# ParetoTI arc analysis
sample_id_tmp = c("LNEN171_TU3","LNEN171_TU4","LNEN171_TU2")
sample_id_tmp.original = "LNEN171_TU1_R1"
LFs_tmpl = list(LFs_LNEN171_TU3,LFs_LNEN171_TU4,LFs_LNEN171_TU2)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN171_TU1_R1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN171_TU1_R1 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN171_TU3, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN171_TU3[rownames(LFs_LNEN171_TU3) == "LNEN171_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN171_TU3 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(LFs_LNEN171_TU4, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN171_TU4[rownames(LFs_LNEN171_TU4) == "LNEN171_TU4",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN171_TU4 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p4 <- ggplot(LFs_LNEN171_TU2, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN171_TU2[rownames(LFs_LNEN171_TU2) == "LNEN171_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN171_TU2 (Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + p4 + plot_layout(ncol=2)
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN171_TU3/LF_scatters_LF1LF2.pdf", h=10,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN171, LFs_LNEN171_TU2, LFs_LNEN171_TU3, LFs_LNEN171_TU4, p1, p2, p3, p4, #patchwork)

```

#### LNEN278s1 - sc-enriched 

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN278s1"),c(1,22,34)]
#         sample_id omics_group               cohort
# 569 LNEN278s1_TU1   Expr.Meth lungNENomicsCombined

# 570 LNEN278s1_TU2   Expr.Meth                 <NA>
# 571 LNEN278s1_TU3   Expr.Meth                 <NA>

LFs_LNEN278s1_TU2 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN278s1_TU2/LFs_319.Cordin.txt") # flipped
LFs_LNEN278s1_TU3 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN278s1_TU3/LFs_319.Cordin.txt") # flipped

colnames(LFs_LNEN278s1_TU2)[5] <- "Factor5_o"
LFs_LNEN278s1_TU2$Factor5 <- LFs_LNEN278s1_TU2$Factor5_o*-1

colnames(LFs_LNEN278s1_TU3)[5] <- "Factor5_o"
LFs_LNEN278s1_TU3$Factor5 <- LFs_LNEN278s1_TU3$Factor5_o*-1

euclidean_LNEN278 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN278s1_TU1"),], LFs_LNEN278s1_TU2[which(rownames(LFs_LNEN278s1_TU2)=="LNEN278s1_TU2"),c(1,2,11)])
euclidean_LNEN278 <- rbind(euclidean_LNEN278, LFs_LNEN278s1_TU3[which(rownames(LFs_LNEN278s1_TU3)=="LNEN278s1_TU3"),c(1,2,11)])

euclidean_LNEN278
#                 Factor1    Factor2   Factor5
# LNEN278s1_TU1 0.4165754 -0.6939597 -5.061644
# LNEN278s1_TU2 0.4772643 -0.6779054 -4.877647
# LNEN278s1_TU3 0.4507787 -0.6706724 -4.910722

dist(euclidean_LNEN278) 
#               LNEN278s1_TU1 LNEN278s1_TU2
# LNEN278s1_TU2    0.19441178              
# LNEN278s1_TU3    0.15649185    0.04298566

euclidean_tmp = euclidean_LNEN278
for(i in 1:(nrow(euclidean_tmp)-1) ) {
    for(j in (i+1):nrow(euclidean_tmp)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_tmp)[i],
                                  sample2=rownames(euclidean_tmp)[j], 
                                 dist = dist(euclidean_tmp[c(i,j),])) )
    }
}

LFs_LNEN278s1_TU2$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN278s1_TU2), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN278s1_TU3$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN278s1_TU3), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN278s1_TU2","LNEN278s1_TU3")
sample_id_tmp.original = "LNEN278s1_TU1"
LFs_tmpl = list(LFs_LNEN278s1_TU2,LFs_LNEN278s1_TU3)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN278s1_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN278s1_TU1 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN278s1_TU2, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN278s1_TU2[rownames(LFs_LNEN278s1_TU2) == "LNEN278s1_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN278s1_TU2 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(LFs_LNEN278s1_TU3, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN278s1_TU3[rownames(LFs_LNEN278s1_TU3) == "LNEN278s1_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN278s1_TU3 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))

p4 <- ggplot(var_cli, aes(x=Factor1, y=Factor5, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor5") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN278s1_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN278s1_TU1 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p5 <- ggplot(LFs_LNEN278s1_TU2, aes(x=Factor1, y=Factor5, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor5") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN278s1_TU2[rownames(LFs_LNEN278s1_TU2) == "LNEN278s1_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN278s1_TU2 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p6 <- ggplot(LFs_LNEN278s1_TU3, aes(x=Factor1, y=Factor5, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor5") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN278s1_TU3[rownames(LFs_LNEN278s1_TU3) == "LNEN278s1_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN278s1_TU3 (Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + p4 + p5 + p6 + plot_layout(ncol=3)
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_free_runs/LNEN278s1_TU2/LF_scatters.pdf", h=10,w=19.5)
#patchwork
#dev.off() 

#rm(euclidean_LNEN278, LFs_LNEN278s1_TU2, LFs_LNEN278s1_TU3, p1, p2, p3, p4, p5, p6, #patchwork)

```

#### LNEN092 - A1

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN092"),c(1,22,34)]
#       sample_id   omics_group               cohort
# 318 LNEN092_TU2 WGS.Expr.Meth lungNENomicsCombined

# 317 LNEN092_TU1      WGS.Meth                 <NA>
# 319 LNEN092_TU3      WGS.Meth                 <NA>

LFs_LNEN092_TU1 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN092_TU1/LFs_319.Cordin.txt") # flipped and LF4
LFs_LNEN092_TU3 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN092_TU3/LFs_319.Cordin.txt") # flipped and LF4 

colnames(LFs_LNEN092_TU1)[5] <- "Factor5_o"
LFs_LNEN092_TU1$Factor5 <- LFs_LNEN092_TU1$Factor4*-1

colnames(LFs_LNEN092_TU3)[5] <- "Factor5_o"
LFs_LNEN092_TU3$Factor5 <- LFs_LNEN092_TU3$Factor4*-1

euclidean_LNEN092 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN092_TU2"),], LFs_LNEN092_TU1[which(rownames(LFs_LNEN092_TU1)=="LNEN092_TU1"),c(1,2,11)])
euclidean_LNEN092 <- rbind(euclidean_LNEN092, LFs_LNEN092_TU3[which(rownames(LFs_LNEN092_TU3)=="LNEN092_TU3"),c(1,2,11)])

euclidean_LNEN092  
#               Factor1   Factor2  Factor5
# LNEN092_TU2 -2.451013 -1.397108 1.053271
# LNEN092_TU1 -2.582366 -1.714655 1.199184
# LNEN092_TU3 -2.971659 -1.923085 1.592573

dist(euclidean_LNEN092) 
#             LNEN092_TU2 LNEN092_TU1
# LNEN092_TU1   0.3733367            
# LNEN092_TU3   0.9157348   0.5913938

euclidean_tmp = euclidean_LNEN092
for(i in 1:(nrow(euclidean_tmp)-1) ) {
    for(j in (i+1):nrow(euclidean_tmp)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_tmp)[i],
                                  sample2=rownames(euclidean_tmp)[j], 
                                 dist = dist(euclidean_tmp[c(i,j),])) )
    }
}

LFs_LNEN092_TU1$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN092_TU1), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN092_TU3$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN092_TU3), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN092_TU1","LNEN092_TU3")
sample_id_tmp.original = "LNEN092_TU2"
LFs_tmpl = list(LFs_LNEN092_TU1,LFs_LNEN092_TU3)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = F,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN092_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN092_TU2 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN092_TU1, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN092_TU1[rownames(LFs_LNEN092_TU1) == "LNEN092_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN092_TU1 (WGS.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(LFs_LNEN092_TU3, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN092_TU3[rownames(LFs_LNEN092_TU3) == "LNEN092_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN092_TU3 (WGS.Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + plot_layout(ncol=2)
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN092_TU1/LF_scatters.pdf", h=10,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN092, LFs_LNEN092_TU1, LFs_LNEN092_TU3, p1, p2, p3, #patchwork)

```

#### LNEN093 - A1 

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN093"),c(1,22,34)]
#       sample_id   omics_group               cohort
# 321 LNEN093_TU2 WGS.Expr.Meth lungNENomicsCombined

# 320 LNEN093_TU1 WGS.Expr.Meth                 <NA>
# 322 LNEN093_TU4 WGS.Expr.Meth                 <NA>
  
LFs_LNEN093_TU1 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN093_TU1/LFs_319.Cordin.txt") 
LFs_LNEN093_TU4 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN093_TU4/LFs_319.Cordin.txt")  

euclidean_LNEN093 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN093_TU2"),], LFs_LNEN093_TU1[which(rownames(LFs_LNEN093_TU1)=="LNEN093_TU1"),c(1,2,5)])
euclidean_LNEN093 <- rbind(euclidean_LNEN093, LFs_LNEN093_TU4[which(rownames(LFs_LNEN093_TU4)=="LNEN093_TU4"),c(1,2,5)])

euclidean_LNEN093  
#               Factor1   Factor2   Factor5
# LNEN093_TU2 -1.750641 -1.027235 0.0690880
# LNEN093_TU1 -1.729054 -1.007547 0.1308096
# LNEN093_TU4 -2.517993 -1.238460 1.2519343

dist(euclidean_LNEN093) 
#             LNEN093_TU2 LNEN093_TU1
# LNEN093_TU1  0.06828729            
# LNEN093_TU4  1.42568246  1.39020361

euclidean_tmp = euclidean_LNEN093
for(i in 1:(nrow(euclidean_tmp)-1) ) {
    for(j in (i+1):nrow(euclidean_tmp)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_tmp)[i],
                                  sample2=rownames(euclidean_tmp)[j], 
                                 dist = dist(euclidean_tmp[c(i,j),])) )
    }
}

LFs_LNEN093_TU1$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN093_TU1), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN093_TU4$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN093_TU4), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN093_TU1","LNEN093_TU4")
sample_id_tmp.original = "LNEN093_TU2"
LFs_tmpl = list(LFs_LNEN093_TU1,LFs_LNEN093_TU4)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN093_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN093_TU2 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN093_TU1, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN093_TU1[rownames(LFs_LNEN093_TU1) == "LNEN093_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN093_TU1 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(LFs_LNEN093_TU4, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN093_TU4[rownames(LFs_LNEN093_TU4) == "LNEN093_TU4",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN093_TU4 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + plot_layout(ncol=2)
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN093_TU1/LF_scatters.pdf", h=10,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN093, LFs_LNEN093_TU1, LFs_LNEN093_TU4, p1, p2, p3, #patchwork)

```

#### LNEN094 - B

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN094"),c(1,22,34)]
#       sample_id   omics_group               cohort
# 325 LNEN094_TU5 WGS.Expr.Meth lungNENomicsCombined

# 323 LNEN094_TU3 WGS.Expr.Meth                 <NA>
# 324 LNEN094_TU4 WGS.Expr.Meth                 <NA>

LFs_LNEN094_TU3 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN094_TU3/LFs_319.Cordin.txt") 
LFs_LNEN094_TU4 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN094_TU4/LFs_319.Cordin.txt") # flipped 

colnames(LFs_LNEN094_TU4)[5] <- "Factor5_o"
LFs_LNEN094_TU4$Factor5 <- LFs_LNEN094_TU4$Factor5_o*-1

euclidean_LNEN094 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN094_TU5"),], LFs_LNEN094_TU3[which(rownames(LFs_LNEN094_TU3)=="LNEN094_TU3"),c(1,2,5)])
euclidean_LNEN094 <- rbind(euclidean_LNEN094, LFs_LNEN094_TU4[which(rownames(LFs_LNEN094_TU4)=="LNEN094_TU4"),c(1,2,11)])

euclidean_LNEN094
#              Factor1    Factor2      Factor5
# LNEN094_TU5 3.149808 -0.8959951 -0.026524359
# LNEN094_TU3 3.163934 -0.9082802 -0.001030539
# LNEN094_TU4 3.212861 -0.8979845 -0.059347095

dist(euclidean_LNEN094) 
#             LNEN094_TU5 LNEN094_TU3
# LNEN094_TU3  0.03162917            
# LNEN094_TU4  0.07111217  0.07681565

euclidean_tmp = euclidean_LNEN094
for(i in 1:(nrow(euclidean_tmp)-1) ) {
    for(j in (i+1):nrow(euclidean_tmp)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_tmp)[i],
                                  sample2=rownames(euclidean_tmp)[j], 
                                 dist = dist(euclidean_tmp[c(i,j),])) )
    }
}

LFs_LNEN094_TU3$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN094_TU3), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN094_TU4$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN094_TU4), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})


# ParetoTI arc analysis
sample_id_tmp = c("LNEN094_TU3","LNEN094_TU4")
sample_id_tmp.original = "LNEN094_TU5"
LFs_tmpl = list(LFs_LNEN094_TU3,LFs_LNEN094_TU4)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN094_TU5",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN094_TU5 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN094_TU3, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN094_TU3[rownames(LFs_LNEN094_TU3) == "LNEN094_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN094_TU3 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(LFs_LNEN094_TU4, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN094_TU4[rownames(LFs_LNEN094_TU4) == "LNEN094_TU4",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN094_TU4 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + plot_layout(ncol=2)
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN094_TU3/LF_scatters.pdf", h=10,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN094, LFs_LNEN094_TU3, LFs_LNEN094_TU4, p1, p2, p3, #patchwork)

```

#### LNEN095 - B

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN095"),c(1,22,34)]
#       sample_id   omics_group               cohort
# 326 LNEN095_TU2 WGS.Expr.Meth lungNENomicsCombined

# 327 LNEN095_TU3 WGS.Expr.Meth                 <NA>
# 328 LNEN095_TU4 WGS.Expr.Meth                 <NA>
  
LFs_LNEN095_TU3 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN095_TU3/LFs_319.Cordin.txt") # flipped 
LFs_LNEN095_TU4 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN095_TU4/LFs_319.Cordin.txt") # flipped 

colnames(LFs_LNEN095_TU3)[5] <- "Factor5_o"
LFs_LNEN095_TU3$Factor5 <- LFs_LNEN095_TU3$Factor5_o*-1

colnames(LFs_LNEN095_TU4)[5] <- "Factor5_o"
LFs_LNEN095_TU4$Factor5 <- LFs_LNEN095_TU4$Factor5_o*-1

euclidean_LNEN095 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN095_TU2"),], LFs_LNEN095_TU3[which(rownames(LFs_LNEN095_TU3)=="LNEN095_TU3"),c(1,2,11)])
euclidean_LNEN095 <- rbind(euclidean_LNEN095, LFs_LNEN095_TU4[which(rownames(LFs_LNEN095_TU4)=="LNEN095_TU4"),c(1,2,11)])

euclidean_LNEN095
#              Factor1    Factor2   Factor5
# LNEN095_TU2 3.488135 -0.9867748 1.0297227
# LNEN095_TU3 3.505899 -1.0246021 0.3149638
# LNEN095_TU4 3.447383 -0.9740413 0.8971120

dist(euclidean_LNEN095) 
#             LNEN095_TU2 LNEN095_TU3
# LNEN095_TU3   0.7159795            
# LNEN095_TU4   0.1393141   0.5872622

euclidean_tmp = euclidean_LNEN095
for(i in 1:(nrow(euclidean_tmp)-1) ) {
    for(j in (i+1):nrow(euclidean_tmp)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_tmp)[i],
                                  sample2=rownames(euclidean_tmp)[j], 
                                 dist = dist(euclidean_tmp[c(i,j),])) )
    }
}


LFs_LNEN095_TU3$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN095_TU3), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN095_TU4$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN095_TU4), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})


# ParetoTI arc analysis
sample_id_tmp = c("LNEN095_TU3","LNEN095_TU4")
sample_id_tmp.original = "LNEN095_TU2"
LFs_tmpl = list(LFs_LNEN095_TU3,LFs_LNEN095_TU4)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN095_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN095_TU2 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN095_TU3, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN095_TU3[rownames(LFs_LNEN095_TU3) == "LNEN095_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN095_TU3 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(LFs_LNEN095_TU4, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN095_TU4[rownames(LFs_LNEN095_TU4) == "LNEN095_TU4",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN095_TU4 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + plot_layout(ncol=2)
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN095_TU3/LF_scatters.pdf", h=10,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN095, LFs_LNEN095_TU3, LFs_LNEN095_TU4, p1, p2, p3, #patchwork)

```

#### LNEN096 - A2

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN096"),c(1,22,34)]
#       sample_id   omics_group               cohort
# 329 LNEN096_TU3 WGS.Expr.Meth lungNENomicsCombined

# 330 LNEN096_TU4 WGS.Expr.Meth                 <NA>
# 331 LNEN096_TU5 WGS.Expr.Meth                 <NA>
  
LFs_LNEN096_TU4 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN096_TU4/LFs_319.Cordin.txt") 
LFs_LNEN096_TU5 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN096_TU5/LFs_319.Cordin.txt") # flipped 

colnames(LFs_LNEN096_TU5)[5] <- "Factor5_o"
LFs_LNEN096_TU5$Factor5 <- LFs_LNEN096_TU5$Factor5_o*-1

euclidean_LNEN096 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN096_TU3"),], LFs_LNEN096_TU4[which(rownames(LFs_LNEN096_TU4)=="LNEN096_TU4"),c(1,2,5)])
euclidean_LNEN096 <- rbind(euclidean_LNEN096, LFs_LNEN096_TU5[which(rownames(LFs_LNEN096_TU5)=="LNEN096_TU5"),c(1,2,11)])

euclidean_LNEN096
#               Factor1  Factor2   Factor5
# LNEN096_TU3 0.2316417 2.180217 0.7336200
# LNEN096_TU4 0.2799395 2.195582 0.7827278
# LNEN096_TU5 0.2518077 2.106863 0.7343484

dist(euclidean_LNEN096) 
#             LNEN096_TU3 LNEN096_TU4
# LNEN096_TU4  0.07057144            
# LNEN096_TU5  0.07607851  0.10489468

euclidean_tmp = euclidean_LNEN096
for(i in 1:(nrow(euclidean_tmp)-1) ) {
    for(j in (i+1):nrow(euclidean_tmp)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_tmp)[i],
                                  sample2=rownames(euclidean_tmp)[j], 
                                 dist = dist(euclidean_tmp[c(i,j),])) )
    }
}

LFs_LNEN096_TU4$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN096_TU4), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN096_TU5$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN096_TU5), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN096_TU4","LNEN096_TU5")
sample_id_tmp.original = "LNEN096_TU3"
LFs_tmpl = list(LFs_LNEN096_TU4,LFs_LNEN096_TU5)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN096_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN096_TU3 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN096_TU4, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN096_TU4[rownames(LFs_LNEN096_TU4) == "LNEN096_TU4",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN096_TU4 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(LFs_LNEN096_TU5, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN096_TU5[rownames(LFs_LNEN096_TU5) == "LNEN096_TU5",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN096_TU5 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + plot_layout(ncol=2)
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN096_TU4/LF_scatters.pdf", h=10,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN096, LFs_LNEN096_TU4, LFs_LNEN096_TU5, p1, p2, p3, #patchwork)

```

#### LNEN097 - A1

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN097"),c(1,22,34)]
#       sample_id   omics_group               cohort
# 334 LNEN097_TU5 WGS.Expr.Meth lungNENomicsCombined

# 332 LNEN097_TU3 WGS.Expr.Meth                 <NA>
# 333 LNEN097_TU4 WGS.Expr.Meth                 <NA>

LFs_LNEN097_TU3 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN097_TU3/LFs_319.Cordin.txt") # flipped 
LFs_LNEN097_TU4 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN097_TU4/LFs_319.Cordin.txt") 

colnames(LFs_LNEN097_TU3)[5] <- "Factor5_o"
LFs_LNEN097_TU3$Factor5 <- LFs_LNEN097_TU3$Factor5_o*-1

euclidean_LNEN097 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN097_TU5"),], LFs_LNEN097_TU3[which(rownames(LFs_LNEN097_TU3)=="LNEN097_TU3"),c(1,2,11)])
euclidean_LNEN097 <- rbind(euclidean_LNEN097, LFs_LNEN097_TU4[which(rownames(LFs_LNEN097_TU4)=="LNEN097_TU4"),c(1,2,5)])

euclidean_LNEN097
#               Factor1    Factor2   Factor5
# LNEN097_TU5 -2.268142 -0.7587492 1.1086665
# LNEN097_TU3 -2.179654 -0.7767396 0.9864418
# LNEN097_TU4 -2.235654 -0.7727378 1.1538647

dist(euclidean_LNEN097) 
#             LNEN097_TU5 LNEN097_TU3
# LNEN097_TU3  0.15196248            
# LNEN097_TU4  0.05739377  0.17658542

euclidean_tmp = euclidean_LNEN097
for(i in 1:(nrow(euclidean_tmp)-1) ) {
    for(j in (i+1):nrow(euclidean_tmp)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_tmp)[i],
                                  sample2=rownames(euclidean_tmp)[j], 
                                 dist = dist(euclidean_tmp[c(i,j),])) )
    }
}


LFs_LNEN097_TU3$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN097_TU3), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN097_TU4$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN097_TU4), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN097_TU3","LNEN097_TU4")
sample_id_tmp.original = "LNEN097_TU5"
LFs_tmpl = list(LFs_LNEN097_TU3,LFs_LNEN097_TU4)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN097_TU5",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN097_TU5 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN097_TU3, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN097_TU3[rownames(LFs_LNEN097_TU3) == "LNEN097_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN097_TU3 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(LFs_LNEN097_TU4, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN097_TU4[rownames(LFs_LNEN097_TU4) == "LNEN097_TU4",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN097_TU4 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + plot_layout(ncol=2)
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN097_TU3/LF_scatters.pdf", h=10,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN097, LFs_LNEN097_TU3, LFs_LNEN097_TU4, p1, p2, p3, #patchwork)

```

#### LNEN100

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN100"),c(1,22,34)]
#       sample_id   omics_group               cohort
# 338 LNEN100_TU1 WGS.Expr.Meth lungNENomicsCombined

# 339 LNEN100_TU2 WGS.Expr.Meth                 <NA>
# 340 LNEN100_TU3 WGS.Expr.Meth                 <NA>

LFs_LNEN100_TU2 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN100_TU2/LFs_319.Cordin.txt") 
LFs_LNEN100_TU3 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN100_TU3/LFs_319.Cordin.txt")  

euclidean_LNEN100 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN100_TU1"),], LFs_LNEN100_TU2[which(rownames(LFs_LNEN100_TU2)=="LNEN100_TU2"),c(1,2,5)])
euclidean_LNEN100 <- rbind(euclidean_LNEN100, LFs_LNEN100_TU3[which(rownames(LFs_LNEN100_TU3)=="LNEN100_TU3"),c(1,2,5)])

euclidean_LNEN100
#               Factor1   Factor2     Factor5
# LNEN100_TU1 -2.536757 -1.239445  0.08371034
# LNEN100_TU2 -2.371537 -1.236590  0.19695309
# LNEN100_TU3 -1.792738 -1.157484 -0.48354856

dist(euclidean_LNEN100) 
#             LNEN100_TU1 LNEN100_TU2
# LNEN100_TU2   0.2003241            
# LNEN100_TU3   0.9391835   0.8968553

euclidean_tmp = euclidean_LNEN100
for(i in 1:(nrow(euclidean_tmp)-1) ) {
    for(j in (i+1):nrow(euclidean_tmp)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_tmp)[i],
                                  sample2=rownames(euclidean_tmp)[j], 
                                 dist = dist(euclidean_tmp[c(i,j),])) )
    }
}

LFs_LNEN100_TU2$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN100_TU2), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN100_TU3$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN100_TU3), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN100_TU2","LNEN100_TU3")
sample_id_tmp.original = "LNEN100_TU1"
LFs_tmpl = list(LFs_LNEN100_TU2,LFs_LNEN100_TU3)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN100_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN100_TU1 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN100_TU2, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN100_TU2[rownames(LFs_LNEN100_TU2) == "LNEN100_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN100_TU2 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(LFs_LNEN100_TU3, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN100_TU3[rownames(LFs_LNEN100_TU3) == "LNEN100_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN100_TU3 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + plot_layout(ncol=2)
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN100_TU2/LF_scatters.pdf", h=10,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN100, LFs_LNEN100_TU2, LFs_LNEN100_TU3, p1, p2, p3, #patchwork)

```

#### LNEN101 - A2

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN101"),c(1,22,34)]
#       sample_id omics_group               cohort
# 341 LNEN101_TU1    WGS.Meth lungNENomicsCombined

# 342 LNEN101_TU2    WGS.Meth                 <NA>

LFs_LNEN101_TU2 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN101_TU2/LFs_319.Cordin.txt") 

euclidean_LNEN101 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN101_TU1"),], LFs_LNEN101_TU2[which(rownames(LFs_LNEN101_TU2)=="LNEN101_TU2"),c(1,2,5)])

euclidean_LNEN101
#                Factor1  Factor2    Factor5
# LNEN101_TU1 -0.5850576 2.054899 -0.4158585
# LNEN101_TU2 -0.3922029 1.624136 -0.3209341

dist(euclidean_LNEN101) 
#             LNEN101_TU1
# LNEN101_TU2   0.4814153

euclidean_tmp = euclidean_LNEN101
for(i in 1:(nrow(euclidean_tmp)-1) ) {
    for(j in (i+1):nrow(euclidean_tmp)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_tmp)[i],
                                  sample2=rownames(euclidean_tmp)[j], 
                                 dist = dist(euclidean_tmp[c(i,j),])) )
    }
}

LFs_LNEN101_TU2$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN101_TU2), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN101_TU2")
sample_id_tmp.original = "LNEN101_TU1"
LFs_tmpl = list(LFs_LNEN101_TU2)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN101_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN101_TU1 (WGS.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN101_TU2, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN101_TU2[rownames(LFs_LNEN101_TU2) == "LNEN101_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN101_TU2 (WGS.Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN101_TU2/LF_scatters.pdf", h=5,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN101, LFs_LNEN101_TU2, p1, p2, #patchwork)

```

#### LNEN102 

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN102"),c(1,22,34)]
#       sample_id omics_group               cohort
# 343 LNEN102_TU1    WGS.Meth lungNENomicsCombined

# 344 LNEN102_TU2    WGS.Meth                 <NA>
# 345 LNEN102_TU3    WGS.Meth                 <NA>

LFs_LNEN102_TU2 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN102_TU2/LFs_319.Cordin.txt") 
LFs_LNEN102_TU3 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN102_TU3/LFs_319.Cordin.txt") # flipped 

colnames(LFs_LNEN102_TU3)[5] <- "Factor5_o"
LFs_LNEN102_TU3$Factor5 <- LFs_LNEN102_TU3$Factor5_o*-1

euclidean_LNEN102 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN102_TU1"),], LFs_LNEN102_TU2[which(rownames(LFs_LNEN102_TU2)=="LNEN102_TU2"),c(1,2,5)])
euclidean_LNEN102 <- rbind(euclidean_LNEN102, LFs_LNEN102_TU3[which(rownames(LFs_LNEN102_TU3)=="LNEN102_TU3"),c(1,2,11)])

euclidean_LNEN102
#                Factor1  Factor2      Factor5
# LNEN102_TU1 0.05566161 1.574689 -0.002322475
# LNEN102_TU2 0.09014203 1.653584  0.051849434
# LNEN102_TU3 0.09103609 1.796466  0.325757352

dist(euclidean_LNEN102) 
#             LNEN102_TU1 LNEN102_TU2
# LNEN102_TU2   0.1017247            
# LNEN102_TU3   0.3975837   0.3089363

euclidean_tmp = euclidean_LNEN102
for(i in 1:(nrow(euclidean_tmp)-1) ) {
    for(j in (i+1):nrow(euclidean_tmp)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_tmp)[i],
                                  sample2=rownames(euclidean_tmp)[j], 
                                 dist = dist(euclidean_tmp[c(i,j),])) )
    }
}

LFs_LNEN102_TU2$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN102_TU2), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN102_TU3$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN102_TU3), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN102_TU2","LNEN102_TU3")
sample_id_tmp.original = "LNEN102_TU1"
LFs_tmpl = list(LFs_LNEN102_TU2,LFs_LNEN102_TU3)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN102_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN102_TU1 (WGS.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN102_TU2, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN102_TU2[rownames(LFs_LNEN102_TU2) == "LNEN102_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN102_TU2 (WGS.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(LFs_LNEN102_TU3, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN102_TU3[rownames(LFs_LNEN102_TU3) == "LNEN102_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN102_TU3 (WGS.Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + plot_layout(ncol=2)
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN102_TU2/LF_scatters.pdf", h=10,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN102, LFs_LNEN102_TU2, LFs_LNEN102_TU3, p1, p2, p3, #patchwork)

```

#### LNEN104 - A1

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN104"),c(1,22,34)]
#       sample_id   omics_group               cohort
# 350 LNEN104_TU3 WGS.Expr.Meth lungNENomicsCombined

# 348 LNEN104_TU1 WGS.Expr.Meth                 <NA>
# 349 LNEN104_TU2          Expr                 <NA>

LFs_LNEN104_TU1 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN104_TU1/LFs_319.Cordin.txt") 
LFs_LNEN104_TU2 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN104_TU2/LFs_319.Cordin.txt") 

euclidean_LNEN104 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN104_TU3"),], LFs_LNEN104_TU1[which(rownames(LFs_LNEN104_TU1)=="LNEN104_TU1"),c(1,2,5)])
euclidean_LNEN104 <- rbind(euclidean_LNEN104, LFs_LNEN104_TU2[which(rownames(LFs_LNEN104_TU2)=="LNEN104_TU2"),c(1,2,5)])

euclidean_LNEN104
#               Factor1   Factor2    Factor5
# LNEN104_TU3 -1.927012 -1.064172 -0.6872283
# LNEN104_TU1 -1.908456 -1.081423 -0.9390230
# LNEN104_TU2 -1.871344 -1.158222 -0.1777390

dist(euclidean_LNEN104) 
#             LNEN104_TU3 LNEN104_TU1
# LNEN104_TU1   0.2530662            
# LNEN104_TU2   0.5210793   0.7660473

euclidean_tmp = euclidean_LNEN104
for(i in 1:(nrow(euclidean_tmp)-1) ) {
    for(j in (i+1):nrow(euclidean_tmp)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_tmp)[i],
                                  sample2=rownames(euclidean_tmp)[j], 
                                 dist = dist(euclidean_tmp[c(i,j),])) )
    }
}

LFs_LNEN104_TU1$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN104_TU1), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN104_TU2$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN104_TU2), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN104_TU1","LNEN104_TU2")
sample_id_tmp.original = "LNEN104_TU3"
LFs_tmpl = list(LFs_LNEN104_TU1,LFs_LNEN104_TU2)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN104_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN104_TU3 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN104_TU1, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN104_TU1[rownames(LFs_LNEN104_TU1) == "LNEN104_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN104_TU1 (WGS.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(LFs_LNEN104_TU2, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN104_TU2[rownames(LFs_LNEN104_TU2) == "LNEN104_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN104_TU2 (Expr)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + plot_layout(ncol=2)
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN104_TU1/LF_scatters.pdf", h=10,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN104, LFs_LNEN104_TU1, LFs_LNEN104_TU2, p1, p2, p3, #patchwork)

```

#### LNEN105 - A2

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN105"),c(1,22,34)]
#       sample_id omics_group               cohort
# 352 LNEN105_TU1    WGS.Meth lungNENomicsCombined

# 351 LNEN105_TU2    WGS.Meth                 <NA>

LFs_LNEN105_TU2 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN105_TU2/LFs_319.Cordin.txt") 

euclidean_LNEN105 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN105_TU1"),], LFs_LNEN105_TU2[which(rownames(LFs_LNEN105_TU2)=="LNEN105_TU2"),c(1,2,5)])

euclidean_LNEN105
#               Factor1    Factor2    Factor5
# LNEN105_TU1 -1.755940 -0.9604352 -0.4556107
# LNEN105_TU2 -1.632724 -0.9936359  0.1317790

dist(euclidean_LNEN105) 
#             LNEN105_TU1
# LNEN105_TU2   0.6010917
euclidean_tmp = euclidean_LNEN105
for(i in 1:(nrow(euclidean_tmp)-1) ) {
    for(j in (i+1):nrow(euclidean_tmp)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_tmp)[i],
                                  sample2=rownames(euclidean_tmp)[j], 
                                 dist = dist(euclidean_tmp[c(i,j),])) )
    }
}


LFs_LNEN105_TU2$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN105_TU2), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN105_TU2")
sample_id_tmp.original = "LNEN105_TU1"
LFs_tmpl = list(LFs_LNEN105_TU2)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN105_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN105_TU1 (WGS.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN105_TU2, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN105_TU2[rownames(LFs_LNEN105_TU2) == "LNEN105_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN105_TU2 (WGS.Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN105_TU2/LF_scatters.pdf", h=5,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN105, LFs_LNEN105_TU2, p1, p2, #patchwork)

```

#### LNEN107 - sc-enriched 

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN107"),c(1,22,34)]
#       sample_id   omics_group               cohort
# 356 LNEN107_TU2 WGS.Expr.Meth lungNENomicsCombined

# 355 LNEN107_TU1      WGS.Meth                 <NA>

LFs_LNEN107_TU1 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN107_TU1/LFs_319.Cordin.txt") # flipped 

colnames(LFs_LNEN107_TU1)[5] <- "Factor5_o"
LFs_LNEN107_TU1$Factor5 <- LFs_LNEN107_TU1$Factor5_o*-1

euclidean_LNEN107 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN107_TU2"),], LFs_LNEN107_TU1[which(rownames(LFs_LNEN107_TU1)=="LNEN107_TU1"),c(1,2,11)]) 

euclidean_LNEN107
#                Factor1    Factor2    Factor5
# LNEN107_TU2 -0.4343639 -0.8504277 -2.0121074
# LNEN107_TU1 -1.5178591 -1.3522462 -0.1967809

dist(euclidean_LNEN107) 
#             LNEN107_TU2
# LNEN107_TU1    2.172831
euclidean_tmp = euclidean_LNEN107
for(i in 1:(nrow(euclidean_tmp)-1) ) {
    for(j in (i+1):nrow(euclidean_tmp)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_tmp)[i],
                                  sample2=rownames(euclidean_tmp)[j], 
                                 dist = dist(euclidean_tmp[c(i,j),])) )
    }
}


LFs_LNEN107_TU1$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN107_TU1), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN107_TU1")
sample_id_tmp.original = "LNEN107_TU2"
LFs_tmpl = list(LFs_LNEN107_TU1)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN107_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN107_TU2 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN107_TU1, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN107_TU1[rownames(LFs_LNEN107_TU1) == "LNEN107_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN107_TU1 (WGS.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(var_cli, aes(x=Factor1, y=Factor5, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor5") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN107_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN107_TU2 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p4 <- ggplot(LFs_LNEN107_TU1, aes(x=Factor1, y=Factor5, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor5") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN107_TU1[rownames(LFs_LNEN107_TU1) == "LNEN107_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN107_TU1 (WGS.Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + p4
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN107_TU1/LF_scatters.pdf", h=10,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN107, LFs_LNEN107_TU1, p1, p2, p3, p4, #patchwork)

```

#### LNEN108 - A1

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN108"),c(1,22,34)]
#       sample_id   omics_group               cohort
# 357 LNEN108_TU1 WGS.Expr.Meth lungNENomicsCombined

# 358 LNEN108_TU2 WGS.Expr.Meth                 <NA>
# 359 LNEN108_TU3 WGS.Expr.Meth                 <NA>
  
LFs_LNEN108_TU2 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN108_TU2/LFs_319.Cordin.txt") # flipped 
LFs_LNEN108_TU3 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN108_TU3/LFs_319.Cordin.txt") 

colnames(LFs_LNEN108_TU2)[5] <- "Factor5_o"
LFs_LNEN108_TU2$Factor5 <- LFs_LNEN108_TU2$Factor5_o*-1

euclidean_LNEN108 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN108_TU1"),], LFs_LNEN108_TU2[which(rownames(LFs_LNEN108_TU2)=="LNEN108_TU2"),c(1,2,11)])
euclidean_LNEN108 <- rbind(euclidean_LNEN108, LFs_LNEN108_TU3[which(rownames(LFs_LNEN108_TU3)=="LNEN108_TU3"),c(1,2,5)])

euclidean_LNEN108
#               Factor1   Factor2     Factor5
# LNEN108_TU1 -1.988549 -1.089932 -0.09061278
# LNEN108_TU2 -2.307058 -1.128642 -0.09782063
# LNEN108_TU3 -2.094245 -1.101446  0.35347688

dist(euclidean_LNEN108) 
#             LNEN108_TU1 LNEN108_TU2
# LNEN108_TU2   0.3209337            
# LNEN108_TU3   0.4566396   0.4996986

euclidean_tmp = euclidean_LNEN108
for(i in 1:(nrow(euclidean_tmp)-1) ) {
    for(j in (i+1):nrow(euclidean_tmp)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_tmp)[i],
                                  sample2=rownames(euclidean_tmp)[j], 
                                 dist = dist(euclidean_tmp[c(i,j),])) )
    }
}

LFs_LNEN108_TU2$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN108_TU2), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN108_TU3$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN108_TU3), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN108_TU2","LNEN108_TU3")
sample_id_tmp.original = "LNEN108_TU1"
LFs_tmpl = list(LFs_LNEN108_TU2,LFs_LNEN108_TU3)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN108_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN108_TU1 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN108_TU2, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN108_TU2[rownames(LFs_LNEN108_TU2) == "LNEN108_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN108_TU2 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(LFs_LNEN108_TU3, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN108_TU3[rownames(LFs_LNEN108_TU3) == "LNEN108_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN108_TU3 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + plot_layout(ncol=2)
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN108_TU2/LF_scatters.pdf", h=10,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN108, LFs_LNEN108_TU2, LFs_LNEN108_TU3, p1, p2, p3, #patchwork)

```

#### LNEN111 - B

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN111"),c(1,22,34)]
#       sample_id   omics_group               cohort
# 363 LNEN111_TU2 WGS.Expr.Meth lungNENomicsCombined

# 362 LNEN111_TU1 WGS.Expr.Meth                 <NA>

LFs_LNEN111_TU1 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN111_TU1/LFs_319.Cordin.txt") # flipped 

colnames(LFs_LNEN111_TU1)[5] <- "Factor5_o"
LFs_LNEN111_TU1$Factor5 <- LFs_LNEN111_TU1$Factor5_o*-1

euclidean_LNEN111 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN111_TU2"),], LFs_LNEN111_TU1[which(rownames(LFs_LNEN111_TU1)=="LNEN111_TU1"),c(1,2,11)])

euclidean_LNEN111
#              Factor1    Factor2    Factor5
# LNEN111_TU2 2.090541 -0.8640664 -0.9534412
# LNEN111_TU1 3.354646 -1.1536867  1.2124263

dist(euclidean_LNEN111) 
#             LNEN111_TU2
# LNEN111_TU1    2.524446

euclidean_tmp = euclidean_LNEN111
for(i in 1:(nrow(euclidean_tmp)-1) ) {
    for(j in (i+1):nrow(euclidean_tmp)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_tmp)[i],
                                  sample2=rownames(euclidean_tmp)[j], 
                                 dist = dist(euclidean_tmp[c(i,j),])) )
    }
}


LFs_LNEN111_TU1$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN111_TU1), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN111_TU1")
sample_id_tmp.original = "LNEN111_TU2"
LFs_tmpl = list(LFs_LNEN111_TU1)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN111_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN111_TU2 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN111_TU1, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN111_TU1[rownames(LFs_LNEN111_TU1) == "LNEN111_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN111_TU1 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN111_TU1/LF_scatters.pdf", h=5,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN111, LFs_LNEN111_TU1, p1, p2, #patchwork)

```

#### LNEN113 - A1

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN113"),c(1,22,34)]
#       sample_id   omics_group               cohort
# 367 LNEN113_TU2 WGS.Expr.Meth lungNENomicsCombined

# 366 LNEN113_TU1 WGS.Expr.Meth                 <NA>

LFs_LNEN113_TU1 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN113_TU1/LFs_319.Cordin.txt") 

euclidean_LNEN113 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN113_TU2"),], LFs_LNEN113_TU1[which(rownames(LFs_LNEN113_TU1)=="LNEN113_TU1"),c(1,2,5)])

euclidean_LNEN113
#                Factor1   Factor2     Factor5
# LNEN113_TU2 -1.1500050 0.1784752 -0.21051448
# LNEN113_TU1 -0.9918691 0.1509112 -0.04844451

euclidean_tmp = euclidean_LNEN113
for(i in 1:(nrow(euclidean_tmp)-1) ) {
    for(j in (i+1):nrow(euclidean_tmp)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_tmp)[i],
                                  sample2=rownames(euclidean_tmp)[j], 
                                 dist = dist(euclidean_tmp[c(i,j),])) )
    }
}

dist(euclidean_LNEN113) 
#             LNEN113_TU2
# LNEN113_TU1   0.2281084

LFs_LNEN113_TU1$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN113_TU1), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN113_TU1")
sample_id_tmp.original = "LNEN113_TU2"
LFs_tmpl = list(LFs_LNEN113_TU1)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}


p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN113_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN113_TU2 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN113_TU1, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN113_TU1[rownames(LFs_LNEN113_TU1) == "LNEN113_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN113_TU1 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN113_TU1/LF_scatters.pdf", h=5,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN113, LFs_LNEN113_TU1, p1, p2, #patchwork)

```

#### LNEN114 - A2

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN114"),c(1,22,34)]
#       sample_id   omics_group               cohort
# 369 LNEN114_TU2 WGS.Expr.Meth lungNENomicsCombined

# 370 LNEN114_TU3 WGS.Expr.Meth                 <NA>
# 368 LNEN114_TU1           WGS                 <NA>

LFs_LNEN114_TU1 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN114_TU1/LFs_319.Cordin.txt") # flipped
LFs_LNEN114_TU3 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN114_TU3/LFs_319.Cordin.txt") 

colnames(LFs_LNEN114_TU1)[5] <- "Factor5_o"
LFs_LNEN114_TU1$Factor5 <- LFs_LNEN114_TU1$Factor5_o*-1

euclidean_LNEN114 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN114_TU2"),], LFs_LNEN114_TU1[which(rownames(LFs_LNEN114_TU1)=="LNEN114_TU1"),c(1,2,11)])
euclidean_LNEN114 <- rbind(euclidean_LNEN114, LFs_LNEN114_TU3[which(rownames(LFs_LNEN114_TU3)=="LNEN114_TU3"),c(1,2,5)])

euclidean_LNEN114
#                Factor1       Factor2       Factor5
# LNEN114_TU2 -0.2323451  1.6307865297 -0.5696903650
# LNEN114_TU1 -0.1807411 -0.0003339912 -0.0001175876
# LNEN114_TU3 -0.1991209  1.4922119729 -0.8291505695

dist(euclidean_LNEN114) 
#             LNEN114_TU2 LNEN114_TU1
# LNEN114_TU1   1.7284763            
# LNEN114_TU3   0.2960175   1.7074329

euclidean_tmp = euclidean_LNEN114
for(i in 1:(nrow(euclidean_tmp)-1) ) {
    for(j in (i+1):nrow(euclidean_tmp)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_tmp)[i],
                                  sample2=rownames(euclidean_tmp)[j], 
                                 dist = dist(euclidean_tmp[c(i,j),])) )
    }
}

LFs_LNEN114_TU1$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN114_TU1), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN114_TU3$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN114_TU3), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN114_TU3","LNEN114_TU1")
sample_id_tmp.original = "LNEN114_TU2"
LFs_tmpl = list(LFs_LNEN114_TU3,LFs_LNEN114_TU1)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN114_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN114_TU2 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN114_TU3, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN114_TU3[rownames(LFs_LNEN114_TU3) == "LNEN114_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN114_TU3 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(LFs_LNEN114_TU1, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN114_TU1[rownames(LFs_LNEN114_TU1) == "LNEN114_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN114_TU1 (WGS)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + plot_layout(ncol=2)
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN114_TU3/LF_scatters.pdf", h=10,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN114, LFs_LNEN114_TU1, LFs_LNEN114_TU3, p1, p2, p3, #patchwork)

```

#### LNEN115 - A2

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN115"),c(1,22,34)]
#       sample_id   omics_group               cohort
# 371 LNEN115_TU1 WGS.Expr.Meth lungNENomicsCombined

# 372 LNEN115_TU2 WGS.Expr.Meth                 <NA>

LFs_LNEN115_TU2 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN115_TU2/LFs_319.Cordin.txt") # flipped 

colnames(LFs_LNEN115_TU2)[5] <- "Factor5_o"
LFs_LNEN115_TU2$Factor5 <- LFs_LNEN115_TU2$Factor5_o*-1

euclidean_LNEN115 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN115_TU1"),], LFs_LNEN115_TU2[which(rownames(LFs_LNEN115_TU2)=="LNEN115_TU2"),c(1,2,11)])

euclidean_LNEN115
#                Factor1   Factor2    Factor5
# LNEN115_TU1 0.10216261 2.1636801  0.1084538
# LNEN115_TU2 0.06192309 0.8514418 -1.6638325

dist(euclidean_LNEN115) 
#             LNEN115_TU1
# LNEN115_TU2    2.205581

euclidean_tmp = euclidean_LNEN115
for(i in 1:(nrow(euclidean_tmp)-1) ) {
    for(j in (i+1):nrow(euclidean_tmp)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_tmp)[i],
                                  sample2=rownames(euclidean_tmp)[j], 
                                 dist = dist(euclidean_tmp[c(i,j),])) )
    }
}

LFs_LNEN115_TU2$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN115_TU2), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN115_TU2")
sample_id_tmp.original = "LNEN115_TU1"
LFs_tmpl = list(LFs_LNEN115_TU2)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN115_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN115_TU1 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN115_TU2, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN115_TU2[rownames(LFs_LNEN115_TU2) == "LNEN115_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN115_TU2 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN115_TU2/LF_scatters.pdf", h=5,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN115, LFs_LNEN115_TU2, p1, p2, #patchwork)

```

#### LNEN116 - B

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN116"),c(1,22,34)]
# sample_id   omics_group               cohort
# 373 LNEN116_TU1 WGS.Expr.Meth lungNENomicsCombined

# 375 LNEN116_TU3 WGS.Expr.Meth                 <NA>
# 374 LNEN116_TU2      WGS.Meth                 <NA>
# 376 LNEN116_TU4      WGS.Meth                 <NA>
  
LFs_LNEN116_TU3 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN116_TU3/LFs_319.Cordin.txt") 
LFs_LNEN116_TU2 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN116_TU2/LFs_319.Cordin.txt") 
LFs_LNEN116_TU4 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN116_TU4/LFs_319.Cordin.txt") 

euclidean_LNEN116 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN116_TU1"),], LFs_LNEN116_TU3[which(rownames(LFs_LNEN116_TU3)=="LNEN116_TU3"),c(1,2,5)])
euclidean_LNEN116 <- rbind(euclidean_LNEN116, LFs_LNEN116_TU2[which(rownames(LFs_LNEN116_TU2)=="LNEN116_TU2"),c(1,2,5)])
euclidean_LNEN116 <- rbind(euclidean_LNEN116, LFs_LNEN116_TU4[which(rownames(LFs_LNEN116_TU4)=="LNEN116_TU4"),c(1,2,5)])

euclidean_LNEN116
#              Factor1    Factor2     Factor5
# LNEN116_TU1 3.319714 -0.8727309  0.04673617
# LNEN116_TU3 3.025134 -0.8185595 -0.16225300
# LNEN116_TU2 2.927362 -0.8052039 -0.23005115
# LNEN116_TU4 3.055588 -0.8027608 -0.33013487

dist(euclidean_LNEN116) 
#             LNEN116_TU1 LNEN116_TU3 LNEN116_TU2
# LNEN116_TU3   0.3652243                        
# LNEN116_TU2   0.4848830   0.1197258            
# LNEN116_TU4   0.4655000   0.1713517   0.1626797

euclidean_tmp = euclidean_LNEN116
for(i in 1:(nrow(euclidean_tmp)-1) ) {
    for(j in (i+1):nrow(euclidean_tmp)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_tmp)[i],
                                  sample2=rownames(euclidean_tmp)[j], 
                                 dist = dist(euclidean_tmp[c(i,j),])) )
    }
}

LFs_LNEN116_TU3$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN116_TU3), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN116_TU2$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN116_TU2), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN116_TU4$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN116_TU4), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN116_TU3","LNEN116_TU2","LNEN116_TU4")
sample_id_tmp.original = "LNEN116_TU1"
LFs_tmpl = list(LFs_LNEN116_TU3,LFs_LNEN116_TU2,LFs_LNEN116_TU4)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN116_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN116_TU1 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN116_TU3, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN116_TU3[rownames(LFs_LNEN116_TU3) == "LNEN116_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN116_TU3 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(LFs_LNEN116_TU2, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN116_TU2[rownames(LFs_LNEN116_TU2) == "LNEN116_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN116_TU2 (WGS.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p4 <- ggplot(LFs_LNEN116_TU4, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN116_TU4[rownames(LFs_LNEN116_TU4) == "LNEN116_TU4",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN116_TU4 (WGS.Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + p4 + plot_layout(ncol=2)
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN116_TU3/LF_scatters.pdf", h=10,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN116, LFs_LNEN116_TU2, LFs_LNEN116_TU3, LFs_LNEN116_TU4, p1, p2, p3, p4, #patchwork)

```

#### LNEN117 - A1

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN117"),c(1,22,34)]
#       sample_id   omics_group               cohort
# 377 LNEN117_TU1 WGS.Expr.Meth lungNENomicsCombined

# 378 LNEN117_TU2 WGS.Expr.Meth                 <NA>

LFs_LNEN117_TU2 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN117_TU2/LFs_319.Cordin.txt") 

euclidean_LNEN117 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN117_TU1"),], LFs_LNEN117_TU2[which(rownames(LFs_LNEN117_TU2)=="LNEN117_TU2"),c(1,2,5)])

euclidean_LNEN117
#               Factor1    Factor2   Factor5
# LNEN117_TU1 -1.680601 -0.3433846 0.5376653
# LNEN117_TU2 -1.939289 -0.2723682 0.8130553

dist(euclidean_LNEN117) 
#             LNEN117_TU1
# LNEN117_TU2   0.3844514

euclidean_tmp = euclidean_LNEN117
for(i in 1:(nrow(euclidean_tmp)-1) ) {
    for(j in (i+1):nrow(euclidean_tmp)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_tmp)[i],
                                  sample2=rownames(euclidean_tmp)[j], 
                                 dist = dist(euclidean_tmp[c(i,j),])) )
    }
}


LFs_LNEN117_TU2$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN117_TU2), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN117_TU2")
sample_id_tmp.original = "LNEN117_TU1"
LFs_tmpl = list(LFs_LNEN117_TU2)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN117_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN117_TU1 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN117_TU2, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN117_TU2[rownames(LFs_LNEN117_TU2) == "LNEN117_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN117_TU2 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN117_TU2/LF_scatters.pdf", h=5,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN117, LFs_LNEN117_TU2, p1, p2, #patchwork)
```

#### LNEN118 - A1

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN118"),c(1,22,34)]
#       sample_id   omics_group               cohort
# 380 LNEN118_TU2 WGS.Expr.Meth lungNENomicsCombined

# 379 LNEN118_TU1 WGS.Expr.Meth                 <NA>

LFs_LNEN118_TU1 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN118_TU1/LFs_319.Cordin.txt") 

euclidean_LNEN118 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN118_TU2"),], LFs_LNEN118_TU1[which(rownames(LFs_LNEN118_TU1)=="LNEN118_TU1"),c(1,2,5)])

euclidean_LNEN118
#                 Factor1  Factor2   Factor5
# LNEN118_TU2  0.03387744 1.795116 0.4221233
# LNEN118_TU1 -0.01777880 1.770746 0.2748668

dist(euclidean_LNEN118) 
#             LNEN118_TU2
# LNEN118_TU1   0.1579453

euclidean_tmp = euclidean_LNEN118
for(i in 1:(nrow(euclidean_tmp)-1) ) {
    for(j in (i+1):nrow(euclidean_tmp)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_tmp)[i],
                                  sample2=rownames(euclidean_tmp)[j], 
                                 dist = dist(euclidean_tmp[c(i,j),])) )
    }
}

LFs_LNEN118_TU1$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN118_TU1), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN118_TU1")
sample_id_tmp.original = "LNEN118_TU2"
LFs_tmpl = list(LFs_LNEN118_TU1)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN118_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN118_TU2 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN118_TU1, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN118_TU1[rownames(LFs_LNEN118_TU1) == "LNEN118_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN118_TU1 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN118_TU1/LF_scatters.pdf", h=5,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN118, LFs_LNEN118_TU1, p1, p2, #patchwork)

```

#### LNEN119 - B

```{r}
#technical_complete[which(technical_complete$manuscript_id=="LNEN119"),c(1,22,34)]
#       sample_id   omics_group               cohort
# 383 LNEN119_TU3 WGS.Expr.Meth lungNENomicsCombined

# 381 LNEN119_TU1 WGS.Expr.Meth                 <NA>
# 382 LNEN119_TU2 WGS.Expr.Meth                 <NA>

LFs_LNEN119_TU1 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN119_TU1/LFs_319.Cordin.txt") # flipped
LFs_LNEN119_TU2 <- read.table("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN119_TU2/LFs_319.Cordin.txt") 

colnames(LFs_LNEN119_TU1)[5] <- "Factor5_o"
LFs_LNEN119_TU1$Factor5 <- LFs_LNEN119_TU1$Factor5_o*-1

euclidean_LNEN119 <- rbind(LFs_Pareto[which(rownames(LFs_Pareto)=="LNEN119_TU3"),], LFs_LNEN119_TU1[which(rownames(LFs_LNEN119_TU1)=="LNEN119_TU1"),c(1,2,11)])
euclidean_LNEN119 <- rbind(euclidean_LNEN119, LFs_LNEN119_TU2[which(rownames(LFs_LNEN119_TU2)=="LNEN119_TU2"),c(1,2,5)])

euclidean_LNEN119
#              Factor1    Factor2   Factor5
# LNEN119_TU3 2.503907 -0.6032156 1.1828499
# LNEN119_TU1 2.799374 -0.5994121 0.8352413
# LNEN119_TU2 2.474867 -0.6145923 1.0142323

dist(euclidean_LNEN119) 
#             LNEN119_TU3 LNEN119_TU1
# LNEN119_TU1   0.4562313            
# LNEN119_TU2   0.1714778   0.3709085

euclidean_tmp = euclidean_LNEN119
for(i in 1:(nrow(euclidean_tmp)-1) ) {
    for(j in (i+1):nrow(euclidean_tmp)){
    euclidean_dists = bind_rows(euclidean_dists , c(sample1=rownames(euclidean_tmp)[i],
                                  sample2=rownames(euclidean_tmp)[j], 
                                 dist = dist(euclidean_tmp[c(i,j),])) )
    }
}

LFs_LNEN119_TU1$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN119_TU1), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})
LFs_LNEN119_TU2$archetype_k4_LF3_label <- sapply(rownames(LFs_LNEN119_TU2), function(x) if(x %in% var_cli$sample_id){var_cli$archetype_k4_LF3_label[which(var_cli$sample_id==x)]}else{"ITH"})

# ParetoTI arc analysis
sample_id_tmp = c("LNEN119_TU1","LNEN119_TU2")
sample_id_tmp.original = "LNEN119_TU3"
LFs_tmpl = list(LFs_LNEN119_TU1,LFs_LNEN119_TU2)

arc_ks.LFs.nobootl = lapply(LFs_tmpl, function(x) k_fit_pch( t(x[,c(1,2,5)]), ks = 4, check_installed = T,bootstrap = F, volume_ratio = "t_ratio" ) )

pareto_coord.tab = bind_rows(pareto_coord.tab,
  tibble(sample_id = sample_id_tmp.original,
                          "Ca A1" = proportions_k4LFs3[sample_id_tmp.original,2],"Ca A2" = proportions_k4LFs3[sample_id_tmp.original,4],
                          "Ca B"  = proportions_k4LFs3[sample_id_tmp.original,3],"sc-enriched" = proportions_k4LFs3[sample_id_tmp.original,1]))

for(i in 1:length(arc_ks.LFs.nobootl)){
  arc_ks.LFs.noboot = arc_ks.LFs.nobootl[[i]]
  neworder = apply( cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])),1,which.max)
  arc_ks.LFs.noboot$S = arc_ks.LFs.noboot$S[neworder,]
  all( diag(cor(proportions_k4LFs3[,1:4],t(arc_ks.LFs.noboot$S[1:4,])))>=0.95 ) #not same order => to reorder

  pareto_coord.tab = bind_rows(pareto_coord.tab,
                               tibble(tibble(sample_id = sample_id_tmp[i],
                          "Ca A1" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][2],"Ca A2" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][4],
                          "Ca B"  = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][3],"sc-enriched" = arc_ks.LFs.noboot$S[,sample_id_tmp[i]][1]))
  )
}

# compute silhouette
LFs_tmpl[[1]]$archetype_k4_LF3_label[LFs_tmpl[[1]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp.original,silhouette(as.numeric(as.factor(LFs_tmpl[[1]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_Pareto))[which(rownames(LFs_Pareto)==sample_id_tmp.original),]) )

for(i in 1:length(arc_ks.LFs.nobootl)){
LFs_tmpl[[i]]$archetype_k4_LF3_label[LFs_tmpl[[i]]$archetype_k4_LF3_label=="ITH"] = var_LNET$archetype_k4_LF3_label[var_LNET$sample_id==sample_id_tmp.original]
sil.tab = bind_rows(sil.tab,
                    c(sample=sample_id_tmp[i],silhouette(as.numeric(as.factor(LFs_tmpl[[i]]$archetype_k4_LF3_label)),
                           dist = dist(LFs_tmpl[[i]][,c(1,2,5)]))[which(rownames(LFs_tmpl[[i]])==sample_id_tmp[i]),]) )
}

p1 <- ggplot(var_cli, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=var_cli[var_cli$sample_id == "LNEN119_TU3",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677")) +
  theme_classic() + labs(title="Primary: LNEN119_TU3 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(LFs_LNEN119_TU1, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN119_TU1[rownames(LFs_LNEN119_TU1) == "LNEN119_TU1",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN119_TU1 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))
p3 <- ggplot(LFs_LNEN119_TU2, aes(x=Factor1, y=Factor2, color=archetype_k4_LF3_label)) + xlab("Factor1") + ylab("Factor2") + 
  geom_point(size = 2.5, alpha = 0.8) +
  geom_point(data=LFs_LNEN119_TU2[rownames(LFs_LNEN119_TU2) == "LNEN119_TU2",], pch=21, fill=NA, size=3.5, colour="black", stroke=1) +
  scale_colour_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + labs(title="ITH: LNEN119_TU2 (WGS.Expr.Meth)") + theme(plot.title = element_text(hjust = 0.5))

p1 + p2 + p3 + plot_layout(ncol=2)
#pdf("/data/lungNENomics/work/Descriptive_manuscript_data/MOFA/MOFA.Exp.Meth.Alt.CNV_lungNENomicsCombined_ITH/WGS_runs/LNEN119_TU1/LF_scatters.pdf", h=10,w=13)
#patchwork
#dev.off() 

#rm(euclidean_LNEN119, LFs_LNEN119_TU1, LFs_LNEN119_TU2, p1, p2, p3, patchwork)
```

### Comparison of distances and plot D

We check the euclidean distances, although they can be misleading if the samples stay within a cluster
```{r}
euclidean_dists$dist = as.numeric(euclidean_dists$dist)

euclidean_matrix <- as.matrix(dist(LFs_Pareto))
euclidean_matrix[lower.tri(euclidean_matrix,diag = T)] = NA
euclidean_matrix_A1A2 = as.numeric(euclidean_matrix[which(as.matrix(rownames(euclidean_matrix)) %in%
                                                            rownames(var_cli)[which(var_cli$archetype_k4_LF3_label=="Ca A1")]),
                 which(as.matrix(rownames(euclidean_matrix)) %in% rownames(var_cli)[which(var_cli$archetype_k4_LF3_label=="Ca A2")])])

euclidean_matrix_A1B = as.numeric(euclidean_matrix[which(as.matrix(rownames(euclidean_matrix)) %in% 
                                                           rownames(var_cli)[which(var_cli$archetype_k4_LF3_label=="Ca A1")]),
                 which(as.matrix(rownames(euclidean_matrix)) %in% rownames(var_cli)[which(var_cli$archetype_k4_LF3_label=="Ca B")])])

euclidean_matrix_A1SC = as.numeric(euclidean_matrix[which(as.matrix(rownames(euclidean_matrix)) %in%
                                                            rownames(var_cli)[which(var_cli$archetype_k4_LF3_label=="Ca A1")]),
                 which(as.matrix(rownames(euclidean_matrix)) %in% rownames(var_cli)[which(var_cli$archetype_k4_LF3_label=="sc-enriched")])])

euclidean_matrix_A2B = as.numeric(euclidean_matrix[which(as.matrix(rownames(euclidean_matrix)) %in% 
                                                           rownames(var_cli)[which(var_cli$archetype_k4_LF3_label=="Ca A2")]),
                 which(as.matrix(rownames(euclidean_matrix)) %in% rownames(var_cli)[which(var_cli$archetype_k4_LF3_label=="Ca B")])])

euclidean_matrix_A2SC = as.numeric(euclidean_matrix[which(as.matrix(rownames(euclidean_matrix)) %in%
                                                            rownames(var_cli)[which(var_cli$archetype_k4_LF3_label=="Ca A2")]),
                 which(as.matrix(rownames(euclidean_matrix)) %in% rownames(var_cli)[which(var_cli$archetype_k4_LF3_label=="sc-enriched")])])

euclidean_matrix_BSC = as.numeric(euclidean_matrix[which(as.matrix(rownames(euclidean_matrix)) %in% 
                                                           rownames(var_cli)[which(var_cli$archetype_k4_LF3_label=="Ca B")]),
                 which(as.matrix(rownames(euclidean_matrix)) %in% rownames(var_cli)[which(var_cli$archetype_k4_LF3_label=="sc-enriched")])])

euclidean_matrix_A1A2 = euclidean_matrix_A1A2[!is.na(euclidean_matrix_A1A2)]
euclidean_matrix_A1B  = euclidean_matrix_A1B[!is.na(euclidean_matrix_A1B)]
euclidean_matrix_A1SC = euclidean_matrix_A1SC[!is.na(euclidean_matrix_A1SC)]
euclidean_matrix_A2B  = euclidean_matrix_A2B[!is.na(euclidean_matrix_A2B)]
euclidean_matrix_A2SC = euclidean_matrix_A2SC[!is.na(euclidean_matrix_A2SC)]
euclidean_matrix_BSC  = euclidean_matrix_BSC[!is.na(euclidean_matrix_BSC)]

euclidean_dists.long = bind_rows( tibble(Group="Ca A1",dists = as.numeric(euclidean_matrix_A1)),
                                  tibble(Group="Ca A2",dists = as.numeric(euclidean_matrix_A2)), 
                                  tibble(Group="Ca B",dists = as.numeric(euclidean_matrix_B)), 
                                  tibble(Group="sc-enriched",dists = as.numeric(euclidean_matrix_sc)),
                                  
                                  tibble(Group="Ca A1 - Ca A2",dists = euclidean_matrix_A1A2),
                                  tibble(Group="Ca A1 - Ca B",dists = euclidean_matrix_A1B),
                                  tibble(Group="Ca A1 - sc-enriched",dists = euclidean_matrix_A1SC),
                                  tibble(Group="Ca A2 - Ca B",dists = euclidean_matrix_A2B),
                                  tibble(Group="Ca A2 - sc-enriched",dists = euclidean_matrix_A2SC),
                                  tibble(Group="Ca B - sc-enriched",dists = euclidean_matrix_BSC),
                                  
                                  tibble(Group="ITH",dists = euclidean_dists$dist) 
                                  ) %>% mutate(Group = factor(Group,levels=c("Ca A1","Ca A2","Ca B","sc-enriched",
                                                                             "Ca A1 - Ca A2","Ca A1 - Ca B","Ca A1 - sc-enriched",
                                                                             "Ca A2 - Ca B","Ca A2 - sc-enriched","Ca B - sc-enriched",
                                                                             "ITH")),
                                               Group_simp = case_when(str_detect(Group," - ")~"Between groups",
                                                                      TRUE~Group),
                                               Group_simp = factor(Group_simp,levels=c("Ca A1","Ca A2","Ca B","sc-enriched",
                                                                             "Between groups",
                                                                             "ITH")))
```

Plots:
```{r}
ggplot(euclidean_dists.long, aes(x=Group_simp,y=dists,fill=Group_simp)) + 
  geom_violin(scale="width") + geom_boxplot(width=0.2,fill="white") + 
  scale_fill_manual(name = "Archetype", values=c("Ca A1"="#999933", "Ca A2"="#DDCC77", "Ca B"="#117733", "sc-enriched"="#CC6677", "ITH"="grey")) +
  theme_classic() + ylab("Distance between\nsamples in MOFA") + guides(fill="none") +
  theme(axis.text.x = element_text(angle =45,hjust = 1),axis.title.x = element_blank(),axis.line.x = element_blank(),axis.ticks.x = element_blank())
```

We now check the silhouette, to detect if some samples jump from one cluster to another
```{r}
sil.tab$sil_width = as.numeric(sil.tab$sil_width)
sil.tab$cluster = as.factor(sil.tab$cluster)
levels(sil.tab$cluster) = c("Ca A1","Ca A2","Ca B","sc-enriched")

Fig4D = ggplot(sil.tab,aes(x=1,y=sil_width,fill=cluster)) + geom_beeswarm(col="white",shape=21) + geom_hline(yintercept = 0,linetype="dashed") + 
  theme_classic() + ylab("Silhouette width") + scale_fill_manual(values=arc4) + 
  theme(axis.title.x = element_blank(),axis.text.x = element_blank(),axis.line.x = element_blank(),axis.ticks.x = element_blank()) + guides(fill="none")

ggsave(filename="../../../Figures/Fig4D_sil.svg",Fig4D, height=2.5,width=2)

pareto_coord.tab$patient_id = str_extract(pareto_coord.tab$sample_id,"LNEN[0-9]+")
pareto_coord.tab = left_join(pareto_coord.tab,var_cli_09052024 %>% dplyr::select(sample_id,group,manuscript_id),by=c(patient_id="manuscript_id") )
```

We now plot the samples within the Pareto front space
```{r}
orderpat = pareto_coord.tab %>% arrange(`Ca A1`) %>% pull(patient_id) %>% unique()
pareto_coord.tab$patient_id = factor(as.character(pareto_coord.tab$patient_id),levels=orderpat)
Fig4DbisA1 = ggplot(pareto_coord.tab,aes(x=patient_id,y=`Ca A1`,fill=patient_id)) + geom_point(col="white",shape=21) +
  geom_line() +
  theme_classic() + scale_fill_manual(values=colITH) + facet_wrap(.~group,scales = "free_x") +
  theme(axis.title.x = element_blank(),axis.text.x = element_blank(),axis.line.x = element_blank(),axis.ticks.x = element_blank()) + guides(fill="none")

orderpat = pareto_coord.tab %>% arrange(`Ca A2`) %>% pull(patient_id) %>% unique()
pareto_coord.tab$patient_id = factor(as.character(pareto_coord.tab$patient_id),levels=orderpat)
Fig4DbisA2 = ggplot(pareto_coord.tab,aes(x=patient_id,y=`Ca A2`,fill=patient_id)) + geom_point(col="white",shape=21) +
  geom_line() +
  theme_classic() + scale_fill_manual(values=colITH) + 
  theme(axis.title.x = element_blank(),axis.text.x = element_blank(),axis.line.x = element_blank(),axis.ticks.x = element_blank()) + guides(fill="none")

orderpat = pareto_coord.tab %>% arrange(`Ca B`) %>% pull(patient_id) %>% unique()
pareto_coord.tab$patient_id = factor(as.character(pareto_coord.tab$patient_id),levels=orderpat)
Fig4DbisB = ggplot(pareto_coord.tab,aes(x=patient_id,y=`Ca B`,fill=patient_id)) + geom_point(col="white",shape=21) +
  geom_line() +
  theme_classic() + scale_fill_manual(values=colITH) + 
  theme(axis.title.x = element_blank(),axis.text.x = element_blank(),axis.line.x = element_blank(),axis.ticks.x = element_blank()) + guides(fill="none")

orderpat = pareto_coord.tab %>% arrange(`sc-enriched`) %>% pull(patient_id) %>% unique()
pareto_coord.tab$patient_id = factor(as.character(pareto_coord.tab$patient_id),levels=orderpat)
Fig4DbisSC = ggplot(pareto_coord.tab,aes(x=patient_id,y=`sc-enriched`,fill=patient_id)) + geom_point(col="white",shape=21) + 
  geom_line() +
  theme_classic() + scale_fill_manual(values=colITH) + 
  theme(axis.title.x = element_blank(),axis.text.x = element_blank(),axis.line.x = element_blank(),axis.ticks.x = element_blank()) + guides(fill="none")

Fig4DbisA1+Fig4DbisA2+Fig4DbisB+Fig4DbisSC
```

```{r}
library(Ternary)
# make one ternary per 3-arc combinaisons: A1 A2 B, A1 A2 SC, A1 B SC, A2 B SC

library(rcartocolor)

colITH = colorRampPalette(carto_pal(12, "Safe"), bias = 1, space = c("rgb", "Lab"),
          interpolate = "linear", alpha = FALSE)(41)#(seq(0,1,length.out=41)) #rainbow(41)
names(colITH) = sort(levels(pareto_coord.tab$patient_id))

pareto_coord.tab$patient_id = as.factor(pareto_coord.tab$patient_id)

svg("../../../Figures/Fig4D_pareto_ITH.svg",width=4*2,height = 4*2)
par(mfrow=c(2,2))
for(i in 1:2){
  for(j in (i+1):3){
    for(k in (j+1):4){
      pareto_coord.tab.ijk = pareto_coord.tab[,c(0,i,j,k,5)+1] %>% mutate(isabsent = as.logical(pareto_coord.tab[,-(c(0,i,j,k,5)+1) ]<=0.05))
      #isabsent.patients = pareto_coord.tab.ijk %>% group_by(patient_id) %>% summarize(isabsent=max(isabsent)) %>% filter(isabsent==1) %>% pull(patient_id)
      pareto_coord.tab.ijk = pareto_coord.tab.ijk %>% filter( isabsent) #patient_id %in% isabsent.patients ) # only keep samples well represented?
      # renormalize values
      pareto_coord.tab.ijk[,2:4] = sweep(pareto_coord.tab.ijk[,2:4],1,rowSums(pareto_coord.tab.ijk[,2:4]),"/")
      
      TernaryPlot(point = "up",axis.labels = F, grid.minor.lines = 0,grid.lines = 5,lab.offset = 0.18,
            grid.lty = 'solid', col = rgb(0.9, 0.9, 0.9), grid.col = 'white', 
            axis.col = rgb(0.6, 0.6, 0.6),ticks.lwd = NA, axis.rotate = FALSE,padding = 0.12)
      TernaryLines(list(c(0.5, 0.5, 0), rep(1/3,3)), col = 'grey')
      TernaryLines(list(c(0, 0.5, 0.5), rep(1/3,3)), col = 'grey')
      TernaryLines(list(c(0.5, 0, 0.5), rep(1/3,3)), col = 'grey')

      AddToTernary(points,pareto_coord.tab.ijk[c(2,3,1)+1], 
             pch = 19, cex = 2, bg = alpha("grey", 0.7), col=colITH[as.numeric(pareto_coord.tab.ijk$patient_id)] ) # sc >>A2 >B>A1

      data_points <- list(  c(0, 0, 255),c(255, 0, 0),c(0, 255, 0))
      names(data_points) = c("Ca A1","Ca A2","Ca B","sce")[c(i,j,k)]
      
      xy <- CoordinatesToXY(data_points)
      points(xy[1, ] + c(-sqrt(0.1**2/2),0,sqrt(0.1**2/2)), xy[2, ]+c(-sqrt(0.1**2/2),0.1,-sqrt(0.1**2/2)), 
         pch = 19, cex = 5, col = arc4[c(i,j,k)])
      text(xy[1, ] + c(-sqrt(0.1**2/2),0,sqrt(0.1**2/2)), xy[2, ]+c(-sqrt(0.1**2/2),0.1,-sqrt(0.1**2/2)), names(data_points), cex = 0.8, font = 2,col="white")
      
      for(ii in as.numeric(pareto_coord.tab.ijk$patient_id)){
        TernaryLines(((pareto_coord.tab.ijk %>% filter(as.numeric(patient_id)==ii))[,2:4][,c(2,3,1)] ), col = "black")#colITH[ii] )
      }
      
    }
  }
}
dev.off()

```

3D plot
```{r}
# 3D plot
library(plotly)

A1vect = c(sqrt(3)/3, 0, 0)
A2vect = c(-sqrt(3)/6, -0.5, 0)
Bvect  = c(-sqrt(3)/6 , 0.5,0)
SCEvect= c(0 , 0,sqrt(6)/3)

coords_3d = as.matrix(pareto_coord.tab[,2])%*%A1vect + as.matrix(pareto_coord.tab[,3])%*%A2vect +  
  as.matrix(pareto_coord.tab[,4])%*%Bvect + as.matrix(pareto_coord.tab[,5])%*%SCEvect

Noax <- list(title = "",zeroline = FALSE,showline = FALSE,showticklabels = FALSE,showgrid = FALSE)

scene = list(camera = list(eye = list(x = 1.8, y = 0, z = 0)),xaxis=Noax,yaxis=Noax,zaxis=Noax)

plotly_arcs = plot_ly(x=c(A1vect[1],A2vect[1],Bvect[1],SCEvect[1],coords_3d[,1]), 
                                y=c(A1vect[2],A2vect[2],Bvect[2],SCEvect[2],coords_3d[,2]), 
                                z=c(A1vect[3],A2vect[3],Bvect[3],SCEvect[3],coords_3d[,3]), 
                            color=c(NA,NA,NA,NA,as.character(pareto_coord.tab$patient_id)), #"Ca A1","Ca A2","Ca B","sc-enriched",as.character(pareto_coord.tab$patient_id)),
                            type="scatter3d", mode="markers", colors = c(arc4,colITH),sizes = c(2,2)*1000,
                      size = c(rep(20,4),rep(8,nrow(coords_3d)))  )  %>% 
  plotly::layout(scene=scene,yaxis = Noax,xaxis = Noax,yaxis=Noax, grid = F) %>% 
  add_trace(x=c(A1vect[1],A2vect[1],Bvect[1],A1vect[1],SCEvect[1]), 
            y=c(A1vect[2],A2vect[2],Bvect[2],A1vect[2],SCEvect[2]), 
            z=c(A1vect[3],A2vect[3],Bvect[3],A1vect[3],SCEvect[3]), inherit = F,type="scatter3d",line=list(color="#000000"),marker=list(color="#ffffff00")) %>%
  add_trace(x=c(A2vect[1],SCEvect[1], Bvect[1]), 
            y=c(A2vect[2],SCEvect[2], Bvect[2]), 
            z=c(A2vect[3],SCEvect[3], Bvect[3]),inherit = F,type="scatter3d",line=list(color="#000000"),marker=list(color="#ffffff00")) 

patientids = unique(pareto_coord.tab$patient_id)
for(i in 1:length(patientids)){
plotly_arcs = plotly_arcs %>% add_trace(x=coords_3d[pareto_coord.tab$patient_id==patientids[i],1], 
          y=coords_3d[pareto_coord.tab$patient_id==patientids[i],2], 
          z=coords_3d[pareto_coord.tab$patient_id==patientids[i],3],inherit = F,
          type="scatter3d",line=list(color="#000000"),marker=list(color="#ffffff00"))
}
plotly_arcs
```

## Statistics

How unusual is the distance between regions of 107?
```{r}
ith_id = which( euclidean_dists.long$Group_simp=="ITH" )
res = c()
for(x in ith_id){
  res = rbind(res, euclidean_dists.long %>% group_by(Group) %>% summarize(Quantile= mean(dists>=euclidean_dists.long$dists[x]) ) %>% pull(Quantile) )
}
colnames(res) = levels(euclidean_dists.long$Group)

as_tibble(res) %>% filter(`Ca A1`<0.05 | `Ca A2`<0.05 | `Ca B`<0.05) # a single sample has inter-region distances above 95% of intra-A1 A2 or B (comparison 5, distance of 2.69 )
```

What is the average difference between regions?
```{r}
pareto_coord.tab.arcdiffs = pareto_coord.tab %>% group_by(group,patient_id) %>% summarize(Mean_diff.A1 = mean(dist(`Ca A1`)),
                                                              Mean_diff.A2 = mean(dist(`Ca A2`)),
                                                              Mean_diff.B = mean(dist(`Ca B`)),
                                                              Mean_diff.sce = mean(dist(`sc-enriched`)) ) %>% ungroup()

colMeans(pareto_coord.tab.arcdiffs[,-(1:2)])

pareto_coord.tab.arcdiffs %>% group_by(group) %>% summarize(mean(Mean_diff.A1),mean(Mean_diff.A2),mean(Mean_diff.B),mean(Mean_diff.sce))

```
